# Azure DevOps Pipeline: Pull Request Validation with Code Coverage
# Build + Test + Coverage for .NET 10 solution (MAUI excluded)

trigger: none

pr:
  branches:
    include:
      - main
  paths:
    exclude:
      - '**/*.md'
      - 'docs/**'
      - '.github/**'

pool:
  vmImage: 'windows-latest'

variables:
  buildPlatform: 'x64'
  buildConfiguration: 'Release'
  dotnetVersion: '10.0.x'

stages:
  - stage: Build
    displayName: 'Build & Test'
    jobs:
      - job: BuildAndTest
        displayName: 'Build Solution and Run Tests'
        timeoutInMinutes: 30
        
        steps:
          - checkout: self
            fetchDepth: 1
            clean: true

          # Install .NET 10 SDK
          - task: UseDotNet@2
            displayName: 'Install .NET 10 SDK'
            inputs:
              packageType: 'sdk'
              version: '$(dotnetVersion)'
              includePreviewVersions: true

          # Restore only WinUI, WebApp, and Test projects
          - task: DotNetCoreCLI@2
            displayName: 'Restore NuGet Packages (no MAUI)'
            inputs:
              command: 'restore'
              projects: |
                **/WinUI.csproj
                **/WebApp.csproj
                **/Test.csproj
              feedsToUse: 'select'

          # Build only WinUI + WebApp
          - task: DotNetCoreCLI@2
            displayName: 'Build Solution (no MAUI)'
            inputs:
              command: 'build'
              projects: |
                **/WinUI.csproj
                **/WebApp.csproj
              arguments: '--configuration $(buildConfiguration) --no-restore'

          # Run unit tests with coverage collection
          - task: DotNetCoreCLI@2
            displayName: 'Run Tests with Coverage'
            inputs:
              command: 'test'
              projects: '**/Test.csproj'
              arguments: '--configuration $(buildConfiguration) --no-build --collect:"XPlat Code Coverage" --results-directory $(Agent.TempDirectory)/TestResults'
              publishTestResults: true

          # Install ReportGenerator tool
          - task: DotNetCoreCLI@2
            displayName: 'Install ReportGenerator'
            inputs:
              command: 'custom'
              custom: 'tool'
              arguments: 'install --global dotnet-reportgenerator-globaltool'

          # Generate coverage report
          - script: |
              reportgenerator "-reports:$(Agent.TempDirectory)/TestResults/**/coverage.cobertura.xml" "-targetdir:$(Build.ArtifactStagingDirectory)/CoverageReport" "-reporttypes:HtmlInline_AzurePipelines;Cobertura"
            displayName: 'Generate Coverage Report'

          # Publish code coverage results
          - task: PublishCodeCoverageResults@2
            displayName: 'Publish Coverage Results'
            inputs:
              summaryFileLocation: '$(Build.ArtifactStagingDirectory)/CoverageReport/Cobertura.xml'

          # Publish coverage report as artifact
          - task: PublishBuildArtifacts@1
            displayName: 'Publish Coverage Artifact'
            inputs:
              PathtoPublish: '$(Build.ArtifactStagingDirectory)/CoverageReport'
              ArtifactName: 'CoverageReport'
              publishLocation: 'Container'
