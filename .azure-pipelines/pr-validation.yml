# Azure DevOps Pipeline: Pull Request Validation
# Triggers on PR to main branch - must pass before PR can be completed
# Build + Test for .NET 10 solution

trigger: none  # Only triggered by PR, not by push

pr:
  branches:
    include:
      - main
  paths:
    exclude:
      - '**/*.md'
      - 'docs/**'
      - '.github/**'

pool:
  vmImage: 'windows-latest'

variables:
  solution: '**/*.slnx'
  buildPlatform: 'x64'
  buildConfiguration: 'Release'
  dotnetVersion: '10.0.x'

stages:
  - stage: Build
    displayName: 'Build & Test'
    jobs:
      - job: BuildAndTest
        displayName: 'Build Solution and Run Tests'
        timeoutInMinutes: 30
        
        steps:
          # Checkout code
          - checkout: self
            fetchDepth: 1
            clean: true

          # Install .NET 10 SDK
          - task: UseDotNet@2
            displayName: 'Install .NET 10 SDK'
            inputs:
              packageType: 'sdk'
              version: '$(dotnetVersion)'
              includePreviewVersions: true

          # Install Windows App SDK workload (for WinUI)
          - task: PowerShell@2
            displayName: 'Install Windows App SDK Workload'
            inputs:
              targetType: 'inline'
              script: |
                dotnet workload install maui-windows --skip-manifest-update
                dotnet workload list

          # Restore NuGet packages
          - task: DotNetCoreCLI@2
            displayName: 'Restore NuGet Packages'
            inputs:
              command: 'restore'
              projects: '$(solution)'
              feedsToUse: 'select'

          # Build solution
          - task: DotNetCoreCLI@2
            displayName: 'Build Solution'
            inputs:
              command: 'build'
              projects: '$(solution)'
              arguments: '--configuration $(buildConfiguration) --no-restore'

          # Run unit tests
          - task: DotNetCoreCLI@2
            displayName: 'Run Unit Tests'
            inputs:
              command: 'test'
              projects: '**/Test.csproj'
              arguments: '--configuration $(buildConfiguration) --no-build --logger trx --results-directory $(Agent.TempDirectory)/TestResults'
              publishTestResults: true

          # Publish test results
          - task: PublishTestResults@2
            displayName: 'Publish Test Results'
            condition: succeededOrFailed()
            inputs:
              testResultsFormat: 'VSTest'
              testResultsFiles: '$(Agent.TempDirectory)/TestResults/*.trx'
              mergeTestResults: true
              testRunTitle: 'PR Validation Tests'
