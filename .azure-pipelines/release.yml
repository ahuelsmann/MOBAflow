# Azure DevOps Pipeline: MOBAflow Release
# - Version wird über MinVer aus Git-Tags ermittelt
# - CHANGELOG wird aus Conventional Commits generiert/aktualisiert
#
# WICHTIG:
# - Diese Pipeline hat keinen automatischen Trigger.
# - Sie sollte nur bewusst für Releases gestartet werden.

trigger: none

pool:
  vmImage: 'windows-latest'

variables:
  dotnetVersion: '10.0.x'

stages:
  - stage: Release
    displayName: 'MOBAflow Release'
    jobs:
      - job: BuildAndChangelog
        displayName: 'Determine Version (MinVer) + Update CHANGELOG.md'
        steps:
          - checkout: self
            clean: true
            fetchDepth: 0   # vollständige Git-History für MinVer & Conventional Changelog

          - task: UseDotNet@2
            displayName: 'Install .NET SDK'
            inputs:
              packageType: 'sdk'
              version: '$(dotnetVersion)'
              includePreviewVersions: true

          - task: NodeTool@0
            displayName: 'Install Node.js'
            inputs:
              versionSpec: '20.x'

          - task: PowerShell@2
            displayName: 'Determine version via MinVer'
            inputs:
              targetType: 'inline'
              script: |
                dotnet tool install --global minver-cli --version 5.*
                $env:PATH += ";$env:USERPROFILE\.dotnet\tools"
                $version = minver
                Write-Host "Detected version (MinVer): $version"
                Write-Host "##vso[task.setvariable variable=MobaflowVersion]$version"
              pwsh: true

          - script: |
              cd "$(Build.SourcesDirectory)"
              echo "Ensuring conventional-changelog CLI and preset (conventionalcommits) are available..."
              npm install -g conventional-changelog-cli conventional-changelog-conventionalcommits
              if exist package.json (
                echo "Running npm ci..."
                npm ci
              ) else (
                echo "No package.json found – skipping npm ci."
              )
              if exist docs\CHANGELOG.md (
                echo "Updating docs/CHANGELOG.md using conventional-changelog..."
                npx conventional-changelog -p conventionalcommits -i docs/CHANGELOG.md -s
              ) else (
                echo "docs/CHANGELOG.md not found, creating new file..."
                npx conventional-changelog -p conventionalcommits -o docs/CHANGELOG.md
              )
            displayName: 'Update docs/CHANGELOG.md from Conventional Commits'

          # HINWEIS:
          # - An dieser Stelle können Build/Publish-Schritte für Release-Artefakte folgen.
          # - Commit/Tagging sollte nur in einer separaten, bewusst konfigurierten Pipeline/Stage erfolgen.

