@rendermode InteractiveServer
@inject MainWindowViewModel ViewModel
@using System.ComponentModel
@using Moba.SharedUI.ViewModel
@implements IDisposable

<div class="header-actions">
    <div class="header-toggle">
        <span class="header-toggle-label">Theme</span>
        <label class="toggle-switch">
            <input type="checkbox"
                   checked="@_isDarkTheme"
                   @onchange="OnThemeToggle" />
            <span class="toggle-slider"></span>
        </label>
    </div>

    <div class="header-toggle">
        <span class="header-toggle-label">Connection</span>
        <label class="toggle-switch">
            <input type="checkbox"
                   checked="@ViewModel.IsConnected"
                   @onchange="OnConnectionToggleAsync" />
            <span class="toggle-slider"></span>
        </label>
    </div>

    <div class="header-toggle">
        <span class="header-toggle-label">Track Power</span>
        <label class="toggle-switch">
            <input type="checkbox"
                   checked="@ViewModel.IsTrackPowerOn"
                   @onchange="OnTrackPowerToggleAsync"
                   disabled="@(!ViewModel.IsConnected)" />
            <span class="toggle-slider"></span>
        </label>
    </div>
</div>

@code {
private bool _isDarkTheme;  // Light theme is default for WebApp

    protected override void OnInitialized()
    {
        ViewModel.PropertyChanged += OnViewModelPropertyChanged;
    }

    private void OnViewModelPropertyChanged(object? sender, PropertyChangedEventArgs e)
    {
        InvokeAsync(StateHasChanged);
    }

    private void OnThemeToggle(ChangeEventArgs e)
    {
        if (e.Value is bool isDark)
        {
            _isDarkTheme = isDark;
        }
    }

    private async Task OnConnectionToggleAsync(ChangeEventArgs e)
    {
        if (e.Value is bool shouldConnect)
        {
            if (shouldConnect)
                await ViewModel.ConnectCommand.ExecuteAsync(null);
            else
                await ViewModel.DisconnectCommand.ExecuteAsync(null);
        }
    }

    private async Task OnTrackPowerToggleAsync(ChangeEventArgs e)
    {
        if (e.Value is bool turnOn)
        {
            // Pass the desired state to the command
            await ViewModel.SetTrackPowerCommand.ExecuteAsync(turnOn);
        }
    }

    public void Dispose()
    {
        ViewModel.PropertyChanged -= OnViewModelPropertyChanged;
    }
}

