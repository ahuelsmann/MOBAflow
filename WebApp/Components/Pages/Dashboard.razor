@page "/"
@page "/dashboard"
@using Moba.SharedUI.ViewModel
@inject CounterViewModel ViewModel
@implements IDisposable
@rendermode InteractiveServer

<PageTitle>MOBAdash</PageTitle>

<div class="dashboard-page">
    <div class="dashboard-widgets">
        <ConnectionWidget ViewModel="@ViewModel" />
        <SystemStateWidget ViewModel="@ViewModel" />
        @* Lap Counter Widget (Inline) *@
        <div class="lap-counter-widget card">
            <div class="card-header">
                <h3>Lap Counter Settings</h3>
            </div>
            <div class="card-body">
                <div class="settings-grid">
                    <div class="form-group">
                        <label>Target Lap Count:</label>
                        <input type="number" class="form-control" value="@ViewModel.GlobalTargetLapCount" min="1" disabled="@(!ViewModel.IsConnected)" readonly />
                    </div>
                    <div class="form-group">
                        <label>Timer Filter:</label>
                        <div class="filter-control">
                            <span>@(ViewModel.UseTimerFilter ? "Enabled" : "Disabled") (@ViewModel.TimerIntervalSeconds s)</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="tracks-section">
        <h3 class="section-title">Track Statistics</h3>
        <div class="cards-grid">
            @foreach (var stat in ViewModel.Statistics)
            {
                <div class="track-card card">
                    <div class="card-header">
                        <div class="track-header">
                            <h4 class="track-name">Track @stat.InPort</h4>
                            @if (stat.IsCompleted)
                            {
                                <span class="status-badge completed">Completed</span>
                            }
                            else
                            {
                                <span class="status-badge in-progress">@stat.LapCountFormatted</span>
                            }
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="track-stats">
                            <div class="stat-item">
                                <span class="stat-label">InPort:</span>
                                <span class="stat-value">@stat.InPort</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Lap Count:</span>
                                <span class="stat-value">@stat.Count</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Target:</span>
                                <span class="stat-value">@stat.TargetLapCount</span>
                            </div>
                            @if (stat.LastFeedbackTime.HasValue)
                            {
                                <div class="stat-item">
                                    <span class="stat-label">Last Detected:</span>
                                    <span class="stat-value">@stat.LastFeedbackTimeFormatted</span>
                                </div>
                            }
                            @if (stat.LastLapTime.HasValue)
                            {
                                <div class="stat-item">
                                    <span class="stat-label">Last Lap Time:</span>
                                    <span class="stat-value">@stat.LastLapTimeFormatted</span>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>
</div>

@code {
    protected override void OnInitialized()
    {
        // Subscribe to property changes for real-time updates
        ViewModel.PropertyChanged += OnViewModelPropertyChanged;
    }

    private void OnViewModelPropertyChanged(object? sender, System.ComponentModel.PropertyChangedEventArgs e)
    {
        // Trigger UI re-render when ViewModel properties change
        InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        ViewModel.PropertyChanged -= OnViewModelPropertyChanged;
    }
}