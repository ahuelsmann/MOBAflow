---
description: 'Final Architecture Decision: Generisches Auto-Save Pattern f√ºr alle ViewModels (2026-01-17)'
applyTo: 'SharedUI/ViewModel/**/*.cs'
---

# üèóÔ∏è Final Architecture Decision: Auto-Save Pattern (2026-01-17)

> **Entscheidung:** Einheitliches PropertyChanged-Pattern f√ºr ALLE ViewModels  
> **Status:** ‚úÖ VOLLST√ÑNDIG IMPLEMENTIERT - 100% Coverage  
> **Datum:** 2026-01-17 (Final Refactoring abgeschlossen)

---

## Coverage Matrix (100% ‚úÖ)

| ViewModel | Auto-Save Pattern | Abonniert | Status |
|-----------|-------------------|-----------|--------|
| **WorkflowViewModel** | SetProperty() ‚Üí PropertyChanged | OnSelectedProjectChanged | ‚úÖ |
| **WorkflowActionViewModel** | SetParameter() ‚Üí PropertyChanged ‚Üí propagiert | WorkflowViewModel | ‚úÖ |
| **JourneyViewModel** | SetProperty() ‚Üí PropertyChanged | OnSelectedJourneyChanged | ‚úÖ |
| **StationViewModel** | SetProperty() ‚Üí PropertyChanged | OnSelectedStationChanged | ‚úÖ |
| **ProjectViewModel** | [ObservableProperty] ‚Üí PropertyChanged | OnSelectedProjectChanged | ‚úÖ |
| **TrainViewModel** | SetProperty() ‚Üí PropertyChanged | OnSelectedTrainChanged | ‚úÖ |
| **LocomotiveViewModel** | SetProperty() ‚Üí PropertyChanged | OnSelectedLocomotiveChanged | ‚úÖ |
| **PassengerWagonViewModel** | SetProperty() ‚Üí PropertyChanged | OnSelectedPassengerWagonChanged | ‚úÖ |
| **GoodsWagonViewModel** | SetProperty() ‚Üí PropertyChanged | OnSelectedGoodsWagonChanged | ‚úÖ |

---

## The Generic Pattern (Implementation)

### 1Ô∏è‚É£ ViewModel Properties - SetProperty (Standard)

```csharp
public class LocomotiveViewModel : ObservableObject, IViewModelWrapper<Locomotive>
{
    private readonly Locomotive _model;

    public string Name
    {
        get => _model.Name;
        set => SetProperty(_model.Name, value, _model, (m, v) => m.Name = v);
        // ‚úÖ Automatically triggers PropertyChanged("Name")
    }

    public uint DigitalAddress
    {
        get => _model.DigitalAddress;
        set => SetProperty(_model.DigitalAddress, value, _model, (m, v) => m.DigitalAddress = v);
        // ‚úÖ Automatically triggers PropertyChanged("DigitalAddress")
    }
}
```

### 2Ô∏è‚É£ Nested ViewModels - Propagate as Parent Collection

```csharp
public class WorkflowViewModel : ObservableObject
{
    private readonly Workflow _model;
    public ObservableCollection<object> Actions { get; }

    public WorkflowViewModel(Workflow model, ...)
    {
        // Subscribe to child ViewModels
        foreach (var actionVM in Actions.OfType<WorkflowActionViewModel>())
        {
            actionVM.PropertyChanged += OnActionPropertyChanged;
        }
    }

    /// <summary>
    /// When ANY action property changes, propagate as Actions collection changed.
    /// This way, MainWindowViewModel's single handler catches it.
    /// </summary>
    private void OnActionPropertyChanged(object? sender, PropertyChangedEventArgs e)
    {
        // ‚úÖ Propagate as Actions property changed
        OnPropertyChanged(nameof(Actions));
    }

    // Same for AddAction, DeleteAction, UpdateActionNumbers
    private void AddAction(ActionType actionType)
    {
        // ... create and add action ...
        OnPropertyChanged(nameof(Actions)); // ‚úÖ Trigger auto-save
    }
}
```

### 3Ô∏è‚É£ MainWindowViewModel - Single Generic Handler

```csharp
public partial class MainWindowViewModel : ObservableObject
{
    /// <summary>
    /// Generic handler for ALL ViewModel PropertyChanged events.
    /// Triggers auto-save for any model property change.
    /// Ignores UI-only properties.
    /// </summary>
    private void OnViewModelPropertyChanged(object? sender, PropertyChangedEventArgs e)
    {
        // Ignore properties that don't affect the model
        var ignoredProperties = new[] { "IsSelected", "IsExpanded", "IsHighlighted" };
        
        if (!ignoredProperties.Contains(e.PropertyName))
        {
            _ = SaveSolutionInternalAsync(); // üíæ AUTO-SAVE
        }
    }
}
```

### 4Ô∏è‚É£ MainWindowViewModel - Subscribe All ViewModel-Wrappers

```csharp
public partial class MainWindowViewModel : ObservableObject
{
    // ‚úÖ Journey
    partial void OnSelectedJourneyChanged(JourneyViewModel? value)
    {
        if (value != null)
            value.PropertyChanged += OnViewModelPropertyChanged;
        ResetJourneyCommand.NotifyCanExecuteChanged();
    }

    // ‚úÖ Station
    partial void OnSelectedStationChanged(StationViewModel? value)
    {
        if (value != null)
            value.PropertyChanged += OnViewModelPropertyChanged;
    }

    // ‚úÖ Train
    partial void OnSelectedTrainChanged(TrainViewModel? value)
    {
        if (value != null)
            value.PropertyChanged += OnViewModelPropertyChanged;
    }

    // ‚úÖ Locomotive
    partial void OnSelectedLocomotiveChanged(LocomotiveViewModel? value)
    {
        if (value != null)
            value.PropertyChanged += OnViewModelPropertyChanged;
    }

    // ‚úÖ Passenger Wagon
    partial void OnSelectedPassengerWagonChanged(PassengerWagonViewModel? value)
    {
        if (value != null)
            value.PropertyChanged += OnViewModelPropertyChanged;
    }

    // ‚úÖ Goods Wagon
    partial void OnSelectedGoodsWagonChanged(GoodsWagonViewModel? value)
    {
        if (value != null)
            value.PropertyChanged += OnViewModelPropertyChanged;
    }

    // ‚úÖ Project (+ nested Workflows)
    partial void OnSelectedProjectChanged(ProjectViewModel? value)
    {
        if (value != null)
        {
            value.PropertyChanged += OnViewModelPropertyChanged;
            
            // Subscribe to all workflows in project
            foreach (var workflow in value.Workflows)
            {
                workflow.PropertyChanged += OnViewModelPropertyChanged;
            }
        }
    }
}
```

---

## Auto-Save Flow (Unified)

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ User edits ANY property in ANY ViewModel                         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                  ‚îÇ
                  ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ SetProperty() / SetParameter() / [ObservableProperty]            ‚îÇ
‚îÇ ‚Üí Triggers PropertyChanged("PropertyName")                       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                  ‚îÇ
                  ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ MainWindowViewModel.OnViewModelPropertyChanged()                ‚îÇ
‚îÇ ‚Üí Check if not in ignoredProperties list                        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                  ‚îÇ
                  ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ SaveSolutionInternalAsync()                                     ‚îÇ
‚îÇ ‚Üí Persists to disk                                              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                  ‚îÇ
                  ‚ñº
            üíæ SAVED!
```

---

## Removed Complexity (Before vs After)

### ‚ùå BEFORE (Inconsistent, Complex)

```csharp
// WorkflowViewModel - Extra Event
public event EventHandler? DataChanged;
PropertyChanged += (s, e) => DataChanged?.Invoke(this, EventArgs.Empty);

// JourneyViewModel - Override + Extra Event
public event EventHandler? ModelChanged;
protected override void OnPropertyChanged(PropertyChangedEventArgs e)
{
    base.OnPropertyChanged(e);
    if (!runtimeProperties.Contains(e.PropertyName))
        ModelChanged?.Invoke(this, EventArgs.Empty);
}

// MainWindowViewModel - Multiple Handlers
private void OnWorkflowDataChanged(object? sender, EventArgs e) { ... }
private void OnJourneysPageSelectedObjectChanged(object? value)
{
    if (value is JourneyViewModel journeyVM)
        journeyVM.ModelChanged += _journeyModelChangedHandler;
}
private void OnViewModelPropertyChanged(object? sender, PropertyChangedEventArgs e) { ... }
```

### ‚úÖ AFTER (Simple, Unified)

```csharp
// ALL ViewModels - Same pattern
public string Name
{
    get => _model.Name;
    set => SetProperty(_model.Name, value, _model, (m, v) => m.Name = v);
}

// ALL nested - Same propagation
private void OnActionPropertyChanged(object? sender, PropertyChangedEventArgs e)
{
    OnPropertyChanged(nameof(Actions));
}

// MainWindowViewModel - ONE generic handler
private void OnViewModelPropertyChanged(object? sender, PropertyChangedEventArgs e)
{
    if (!ignoredProperties.Contains(e.PropertyName))
        _ = SaveSolutionInternalAsync();
}
```

---

## Changes Made (2026-01-17)

### JourneyViewModel.cs
- ‚ùå Removed: `public event EventHandler? ModelChanged;`
- ‚ùå Removed: `protected override void OnPropertyChanged(PropertyChangedEventArgs e)` override
- ‚ùå Removed: All `ModelChanged?.Invoke()` calls
- ‚úÖ Result: Simple PropertyChanged propagation like all other ViewModels

### MainWindowViewModel.cs
- ‚ùå Removed: `OnJourneysPageSelectedObjectChanged()` with ModelChanged subscription
- ‚ùå Removed: `_currentJourneyWithModelChangedSubscription` and `_journeyModelChangedHandler` fields
- ‚úÖ Updated: `OnSelectedJourneyChanged()` to subscribe to PropertyChanged
- ‚úÖ Confirmed: All other `OnSelected*Changed()` handlers already subscribe to PropertyChanged

### Result
- ‚úÖ 100% Coverage: Every ViewModel-Wrapper property auto-saves
- ‚úÖ Single Pattern: No exceptions, no special cases
- ‚úÖ Maintenance: New ViewModels automatically work
- ‚úÖ Consistency: CommunityToolkit.Mvvm standards applied everywhere

---

## Lessons Learned

1. **Consistency > Cleverness**
   - One simple pattern beats multiple special patterns
   - Future developers will understand it immediately

2. **MVVM Frameworks Do Work**
   - CommunityToolkit.Mvvm makes PropertyChanged automatic
   - SetProperty() handles the infrastructure
   - Don't reinvent the wheel with custom events

3. **Nested ViewModels Matter**
   - Child PropertyChanged ‚Üí Parent PropertyChanged("Collection")
   - Propagation up the hierarchy is key
   - Avoids needing multiple handler types

4. **Coverage Audits Save Time**
   - Check ALL ViewModel-Wrappers systematically
   - Verify every property path is covered
   - Document the coverage matrix

5. **Generic Handlers Scale**
   - One `OnViewModelPropertyChanged` handles everything
   - Maintenance is centralized
   - New ViewModels benefit automatically

---

## Usage for New ViewModels

When adding a new ViewModel-Wrapper:

```csharp
// 1. Inherit from ObservableObject, IViewModelWrapper<T>
public class MyNewViewModel : ObservableObject, IViewModelWrapper<MyModel>
{
    private readonly MyModel _model;

    // 2. Use SetProperty for all properties
    public string SomeProperty
    {
        get => _model.SomeProperty;
        set => SetProperty(_model.SomeProperty, value, _model, (m, v) => m.SomeProperty = v);
    }

    // ‚úÖ Auto-save works automatically!
}

// 3. In MainWindowViewModel, add subscription
partial void OnSelectedMyNewViewModelChanged(MyNewViewModel? value)
{
    if (value != null)
        value.PropertyChanged += OnViewModelPropertyChanged;
}

// ‚úÖ Done! No extra work needed.
```

---

## Verification Checklist

- [x] All ViewModel-Wrappers use SetProperty() for properties
- [x] All nested ViewModels propagate PropertyChanged
- [x] MainWindowViewModel subscribes to PropertyChanged for all ViewModel-Wrappers
- [x] Action-ViewModels use SetParameter() correctly
- [x] JourneyViewModel removes extra ModelChanged event
- [x] No duplicate patterns or special cases remain
- [x] Build successful
- [x] 100% Auto-Save coverage

---

**Status: ‚úÖ COMPLETE - Generisches Auto-Save Pattern vollst√§ndig implementiert und getestet**
