# ğŸš‚ Copilot Instructions for MOBAflow Project

**Quick Reference Guide** - See linked documents for detailed guidelines.

---

## ğŸŒ Communication Language

**Chat Language**: **Deutsch (German)**
- âœ… All chat conversations with the user should be conducted in **German**
- âœ… Code, documentation, and comments remain in **English**

---

## âœ… Execution Discipline (MANDATORY)
- After each prompt execution: run build, run all tests, and reduce warnings when possible.
- Consider changes complete only after a green build/test.

---

## ğŸ“‹ Project Overview

**MOBAflow** - Model railroad control system built with .NET 10
- **Primary Platform**: Windows (WinUI 3) - "MOBAflow"
- **Secondary Platform**: Android (MAUI) - "MOBAsmart"  
- **Web Platform**: Blazor Server - "MOBAdash"
- **Target Hardware**: Z21 digital command station (UDP)

---

## ğŸ¯ MVP Goals & Product Vision

### **MVP Definition (Minimum Viable Product)**

A **complete MVP** requires full CRUD (Create, Read, Update, Delete) functionality for the entire solution model hierarchy:

#### **Required Features for MVP:**

âœ… **Complete Model Editability** - All model classes in the solution tree must be editable:
- âœ… **Solution** (Root element)
  - âœ… **Project**
    - âœ… **Settings** (configuration for Z21, voices, etc.)
    - âœ… **Journey** (complete journey/timetable with all stops)
      - âœ… **Station** (individual stop with platforms and workflow)
        - âœ… **Platform** (track/platform assignment)
    - âœ… **Workflow** (automation workflows)
      - âœ… **Action** (individual actions: Audio, Announcement, Command, etc.)
    - âœ… **Train** (complete train compositions)
      - âœ… **Locomotive** (engine specifications)
      - âœ… **Wagon** (PassengerWagon, GoodsWagon)

#### **CRUD Operations Required:**

| Operation | Requirement | Example |
|-----------|-------------|---------|
| **Create** | Add new entities via UI | Create new Journey, add Station to Journey |
| **Read** | View/inspect all properties | Display Journey details in PropertyGrid |
| **Update** | Edit all properties via UI | Change Station name, modify Workflow actions |
| **Delete** | Remove entities safely | Delete Station from Journey, remove Action from Workflow |

#### **UI Requirements:**

- âœ… **TreeView Navigation** - Solution â†’ Project â†’ Journeys/Workflows/Trains
- âœ… **PropertyGrid Editing** - Edit all properties for selected entity
- âœ… **Context Menus** - Add/Delete operations via right-click
- âœ… **Drag & Drop** (optional) - Reorder Stations in Journey, Actions in Workflow
- âœ… **Validation** - Prevent invalid operations (e.g., delete Station that's referenced)

#### **Current State (as of architecture analysis):**

- âœ… **Read** - TreeView shows full hierarchy âœ…
- âœ… **Update** - PropertyGrid allows editing âœ…
- âš ï¸ **Create** - Limited support (Project creation exists, but not full CRUD for all entities)
- âš ï¸ **Delete** - Not implemented
- âš ï¸ **Validation** - Minimal

#### **Next Steps to Reach MVP:**

1. **Implement Add/Delete Commands** for all entities in TreeView
2. **Context Menu** for TreeView nodes (Add Station, Delete Journey, etc.)
3. **Validation Logic** - Prevent invalid deletes (e.g., Journey referenced by another Journey)
4. **Save/Load Persistence** - Ensure all changes are persisted correctly
5. **Testing** - Unit tests for CRUD operations on all model classes

### **Strategic Goal:**

> "A user must be able to define a complete Journey with Stations (Stops) via the UI, create various Workflows with Actions, and configure Trains with Locomotives and Wagons - all without editing JSON manually."

---

## ğŸ—ï¸ Architecture (MANDATORY!)

### **Core Principle: Keep Backend Platform-Independent**

âš ï¸ **CRITICAL RULE**: The `Backend` project MUST remain **100% platform-independent**!

- âŒ **NEVER** add UI thread dispatching to Backend (`DispatcherQueue`, `MainThread`, etc.)
- âœ… **ALWAYS** handle platform-specific threading in **platform-specific ViewModels**

```csharp
// âŒ WRONG: Dispatching in Backend
public class JourneyManager
{
#if WINDOWS
    await DispatchToUIThreadAsync(...);  // âŒ BAD!
#endif
}

// âœ… CORRECT: Platform-specific ViewModel handles dispatching
namespace Moba.WinUI.ViewModels.Journey;

public class JourneyViewModel : SharedUI.ViewModel.JourneyViewModel
{
    private readonly DispatcherQueue _dispatcher;
    // Handle UI thread dispatching here âœ…
}
```

---

## ğŸ¨ Project Structure

| Project | Purpose | Target Framework |
|---------|---------|------------------|
| **Backend** | Z21 communication, business logic (platform-independent!) | `net10.0` |
| **SharedUI** | Base ViewModels, shared UI logic | `net10.0` |
| **WinUI** | Windows desktop "MOBAflow" | `net10.0-windows10.0.17763.0` |
| **MAUI** | Android mobile "MOBAsmart" | `net10.0-android36.0` |
| **WebApp** | Blazor Server "MOBAdash" | `net10.0` |
| **Sound** | Audio/TTS functionality | `net10.0` |
| **Test** | Unit tests | `net10.0` |

### Dependency Flow
```
WinUI â†’ SharedUI â†’ Backend
MAUI â†’ SharedUI â†’ Backend
WebApp â†’ SharedUI â†’ Backend
```

---

## ğŸ“ File Organization

### âœ… **One Class Per File**
- File name MUST match class name (e.g., `SystemState.cs`)
- âŒ **NEVER** put multiple public classes in one file

### âœ… **Namespace Conventions**

**Rule:** Namespace MUST match RootNamespace + folder structure

```csharp
// âœ… CORRECT: Namespace matches project structure
// File: Backend\Manager\JourneyManager.cs
namespace Moba.Backend.Manager;

// File: WinUI\Service\IoService.cs
namespace Moba.WinUI.Service;

// File: SharedUI\ViewModel\JourneyViewModel.cs
namespace Moba.SharedUI.ViewModel;
```

**RootNamespace per Project:**
| Project | RootNamespace | Example |
|---------|---------------|---------|
| Backend | `Moba.Backend` | `Moba.Backend.Manager` |
| SharedUI | `Moba.SharedUI` | `Moba.SharedUI.ViewModel` |
| WinUI | `Moba.WinUI` | `Moba.WinUI.Service` |
| MAUI | `Moba.MAUI` | `Moba.MAUI.Service` |
| WebApp | `Moba.WebApp` | `Moba.WebApp.Service` |
| Sound | `Moba.Sound` | `Moba.Sound` |

âš ï¸ **Note:** MAUI.csproj defines `<RootNamespace>Moba.Smart</RootNamespace>` but code uses `Moba.MAUI` for consistency with other projects.

### âœ… **Using Directives**

**Always use absolute namespaces** for clarity and consistency:

```csharp
// âœ… GOOD: Absolute namespace
using Moba.Backend.Model;
using Moba.SharedUI.Service;

// âŒ BAD: Relative namespace
using Backend.Model;  // Ambiguous!
```

### âœ… **Use Sub-Namespaces for Organization**
```csharp
// âœ… GOOD: Organized with sub-namespaces
namespace Moba.Backend.Manager;
namespace Moba.Backend.Model.Action;
namespace Moba.WinUI.Service;

// âŒ BAD: Flat structure
namespace Moba.Backend;  // All classes in one namespace
```

---

## ğŸ“ SharedUI Platform-specific subfolders

To keep platform-specific ViewModels organized while still residing in `SharedUI`, place platform adapters under these subfolders:

- `SharedUI/ViewModel/WinUI` - WinUI-specific ViewModel adapters that dispatch to `DispatcherQueue` and/or use WinUI services.
- `SharedUI/ViewModel/MAUI` - MAUI-specific ViewModel adapters that dispatch to `MainThread` and/or use MAUI services.

These adapters must remain thin: inherit from `SharedUI.ViewModel.*` base ViewModels and perform only UI-thread dispatching or platform service wiring.

Example:

```csharp
namespace Moba.SharedUI.ViewModel.WinUI;

public class JourneyViewModel : Moba.SharedUI.ViewModel.JourneyViewModel
{
    // WinUI dispatching only
}
```

Follow the project's file and namespace conventions when adding these adapters.

---

## ğŸ¯ Mandatory Pre-Flight Checks

**BEFORE implementing ANY feature request:**

1. âœ… **Search Microsoft Learn** for official documentation
2. âœ… **Check for known issues** in .NET 10 / MAUI 10 / WinUI 3
3. âœ… **Propose alternatives** if technology is unstable
4. âœ… **Wait for explicit approval** before coding

### Decision Gate
```
IF (technology is stable AND documented AND appropriate)
    THEN implement
ELSE
    PROPOSE alternatives AND wait for user decision
```

---

## ğŸ› ï¸ Technology Constraints

### .NET 10 LTS (Final Release)
- âœ… Production-ready (released May 20, 2025)
- âœ… Visual Studio 2026 (18.x) required
- âœ… Use C# 13 features where appropriate

### WinUI 3
- âœ… Windows App SDK
- âš ï¸ **No XAML Designer** â†’ Use XAML Hot Reload
- âœ… Use **x:Bind** over **Binding**

### MAUI 10 (Final Release)
- âœ… Production-ready for standard apps
- âœ… Android API 36 stable
- âš ï¸ **Foreground Services still unstable** â†’ Use native Android
- âš ï¸ **Threading Rules CRITICAL!** â†’ See [docs/THREADING.md](docs/THREADING.md)

---

## ğŸ§µ Threading (CRITICAL for MAUI!)

âš ï¸ **Only Main Thread can modify UI properties!**

```csharp
// âŒ BAD: Background thread
private void OnUdpCallback(Data data)
{
    StatusText = "Received!";  // âŒ CRASH on Android!
}

// âœ… GOOD: Dispatched to Main Thread
private void OnUdpCallback(Data data)
{
#if ANDROID || IOS || MACCATALYST || WINDOWS
    MainThread.BeginInvokeOnMainThread(() =>
    {
        StatusText = "Received!";  // âœ… Safe
    });
#endif
}
```

ğŸ“„ **Full Guidelines**: See [docs/THREADING.md](docs/THREADING.md)

---

## ğŸš€ Async/Await Patterns

### Key Rules:
- âœ… Use `async` for I/O-bound work (network, file, database)
- âœ… Suffix methods with `Async`
- âœ… Use `ConfigureAwait(false)` in Backend (not in ViewModels)
- âŒ **NEVER** use `.Result` or `.Wait()` (causes deadlocks)
- âŒ **NEVER** use `async void` (except event handlers)

ğŸ“„ **Full Guidelines**: See [docs/ASYNC-PATTERNS.md](docs/ASYNC-PATTERNS.md)

---

## ğŸ¨ MVVM Pattern

- âœ… Use **CommunityToolkit.Mvvm** (`ObservableObject`, `RelayCommand`)
- âœ… **ALL** UI logic in ViewModels (never in code-behind)
- âœ… ViewModels must be **testable** (no direct UI dependencies)

```csharp
public partial class MyViewModel : ObservableObject
{
    [ObservableProperty]
    private string title = "Default";

    [RelayCommand]
    private async Task DoSomethingAsync()
    {
        // Logic here
    }
}
```

---

## ğŸ”Œ Z21 Hardware & Protocol

**Quick Reference:**
- ğŸ“¡ **Protocol**: UDP on port 21105
- ğŸ  **Default IP**: 192.168.0.111
- ğŸ“¦ **Implementation**: `Backend.Z21` class
- âš ï¸ **Thread Safety**: All events on background thread â†’ Use `MainThread.BeginInvokeOnMainThread()`
- ğŸ“„ **Specification**: [Z21 LAN Protocol V1.13 (PDF)](https://www.z21.eu/media/Kwc_Basic_DownloadTag_Component/47-1652-959-downloadTag/default/69bad87e/1699290251/z21-lan-protokoll.pdf)

### Track Feedback System:
- **InPorts**: Track occupancy detectors
- **Current Setup**: 3 parallel tracks â†’ InPorts 1, 2, 3
- **Use Case**: Lap counting (e.g., cleaning train runs)

---

## ğŸ“š Documentation Sources

### Primary Sources:
1. **Microsoft Learn** - https://learn.microsoft.com/dotnet/
2. **GitHub Issues** - .NET MAUI, WinUI, .NET
3. **NuGet Docs** - CommunityToolkit.Mvvm, CommunityToolkit.Maui, UraniumUI
4. **Z21 Protocol** - See PDF link above

### Search Strategy:
```
1. Search Microsoft Learn first
2. Check GitHub issues for known problems
3. Verify with NuGet package docs
4. Consult Z21 Protocol PDF for hardware details
5. Present findings to user BEFORE coding
```

---

## ğŸš¨ Known Issues

### .NET 10 / MAUI 10 Final:
- âš ï¸ **MAUI Foreground Services**: Still unstable â†’ Native Android implementation
- âš ï¸ **Shell Navigation**: Can be problematic â†’ Prefer `NavigationPage`
- âš ï¸ **Hot Reload with Source Generators**: May not update `ObservableProperty` â†’ Restart debugger

---

## ğŸ“– Detailed Documentation

- ğŸ“ [docs/ARCHITECTURE.md](docs/ARCHITECTURE.md) - Platform-independent Backend guidelines
- ğŸ§µ [docs/THREADING.md](docs/THREADING.md) - MAUI Threading (CRITICAL!)
- ğŸš€ [docs/ASYNC-PATTERNS.md](docs/ASYNC-PATTERNS.md) - Async/Await best practices
- ğŸ”Œ [docs/DI-INSTRUCTIONS.md](docs/DI-INSTRUCTIONS.md) - Dependency Injection guide

---

## âœ… Quick Checklist

**Before committing code:**

- [ ] Backend has NO platform-specific code (`#if WINDOWS`, `MainThread`, etc.)
- [ ] UI updates dispatched to Main Thread (MAUI) or DispatcherQueue (WinUI)
- [ ] All I/O operations use async/await
- [ ] No `.Result` or `.Wait()` on async code
- [ ] File names match class names
- [ ] XML documentation in English
- [ ] Unit tests can run without UI framework
