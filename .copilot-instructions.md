# üöÇ Copilot Instructions for MOBAflow Project

**Quick Reference Guide** - See linked documents for detailed guidelines.

---

## üåê Communication Language

**Chat Language**: **Deutsch (German)**
- ‚úÖ All chat conversations with the user should be conducted in **German**
- ‚úÖ Code, documentation, and comments remain in **English**

---

## ‚úÖ Execution Discipline (MANDATORY)
- After each prompt execution: run build, run all tests, and reduce warnings when possible.
- Consider changes complete only after a green build/test.

---

## üìã Project Overview

**MOBAflow** - Model railroad control system built with .NET 10
- **Primary Platform**: Windows (WinUI 3) - "MOBAflow"
- **Secondary Platform**: Android (MAUI) - "MOBAsmart"  
- **Web Platform**: Blazor Server - "MOBAdash"
- **Target Hardware**: Z21 digital command station (UDP)

---

## üéØ MVP Goals & Product Vision

üìã **Active Plan**: See [Plans/MVP-CRUD-Editor.md](Plans/MVP-CRUD-Editor.md) for detailed implementation roadmap

### **MVP Definition (Minimum Viable Product)**

A **complete MVP** requires full CRUD (Create, Read, Update, Delete) functionality for the entire solution model hierarchy:

#### **Required Features for MVP:**

‚úÖ **Complete Model Editability** - All model classes in the solution tree must be editable:
- ‚úÖ **Solution** (Root element)
  - ‚úÖ **Project**
    - ‚úÖ **Settings** (configuration for Z21, voices, etc.)
    - ‚úÖ **Journey** (complete journey/timetable with all stops)
      - ‚úÖ **Station** (individual stop with platforms and workflow)
        - ‚úÖ **Platform** (track/platform assignment)
    - ‚úÖ **Workflow** (automation workflows)
      - ‚úÖ **Action** (individual actions: Audio, Announcement, Command, etc.)
    - ‚úÖ **Train** (complete train compositions)
      - ‚úÖ **Locomotive** (engine specifications)
      - ‚úÖ **Wagon** (PassengerWagon, GoodsWagon)

#### **CRUD Operations Required:**

| Operation | Requirement | Example |
|-----------|-------------|---------|
| **Create** | Add new entities via UI | Create new Journey, add Station to Journey |
| **Read** | View/inspect all properties | Display Journey details in PropertyGrid |
| **Update** | Edit all properties via UI | Change Station name, modify Workflow actions |
| **Delete** | Remove entities safely | Delete Station from Journey, remove Action from Workflow |

#### **UI Requirements:**

- ‚úÖ **TreeView Navigation** - Solution ‚Üí Project ‚Üí Journeys/Workflows/Trains
- ‚úÖ **PropertyGrid Editing** - Edit all properties for selected entity
- ‚úÖ **Context Menus** - Add/Delete operations via right-click
- ‚úÖ **Drag & Drop** (optional) - Reorder Stations in Journey, Actions in Workflow
- ‚úÖ **Validation** - Prevent invalid operations (e.g., delete Station that's referenced)

#### **Current State (as of architecture analysis):**

- ‚úÖ **Read** - TreeView shows full hierarchy ‚úÖ
- ‚úÖ **Update** - PropertyGrid allows editing ‚úÖ
- ‚ö†Ô∏è **Create** - Limited support (Project creation exists, but not full CRUD for all entities)
- ‚ö†Ô∏è **Delete** - Not implemented
- ‚ö†Ô∏è **Validation** - Minimal

#### **Next Steps to Reach MVP:**

1. **Implement Add/Delete Commands** for all entities in TreeView
2. **Context Menu** for TreeView nodes (Add Station, Delete Journey, etc.)
3. **Validation Logic** - Prevent invalid deletes (e.g., Journey referenced by another Journey)
4. **Save/Load Persistence** - Ensure all changes are persisted correctly
5. **Testing** - Unit tests for CRUD operations on all model classes

### **Strategic Goal:**

> "A user must be able to define a complete Journey with Stations (Stops) via the UI, create various Workflows with Actions, and configure Trains with Locomotives and Wagons - all without editing JSON manually."

---

## üèóÔ∏è Architecture (MANDATORY!)

### **Core Principle: Keep Backend Platform-Independent**

‚ö†Ô∏è **CRITICAL RULE**: The `Backend` project MUST remain **100% platform-independent**!

- ‚ùå **NEVER** add UI thread dispatching to Backend (`DispatcherQueue`, `MainThread`, etc.)
- ‚úÖ **ALWAYS** handle platform-specific threading in **platform-specific ViewModels**

```csharp
// ‚ùå WRONG: Dispatching in Backend
public class JourneyManager
{
#if WINDOWS
    await DispatchToUIThreadAsync(...);  // ‚ùå BAD!
#endif
}

// ‚úÖ CORRECT: Platform-specific ViewModel handles dispatching
namespace Moba.WinUI.ViewModels.Journey;

public class JourneyViewModel : SharedUI.ViewModel.JourneyViewModel
{
    private readonly DispatcherQueue _dispatcher;
    // Handle UI thread dispatching here ‚úÖ
}
```

---

## üé® Project Structure

| Project | Purpose | Target Framework |
|---------|---------|------------------|
| **Backend** | Z21 communication, business logic (platform-independent!) | `net10.0` |
| **SharedUI** | Base ViewModels, shared UI logic | `net10.0` |
| **WinUI** | Windows desktop "MOBAflow" | `net10.0-windows10.0.17763.0` |
| **MAUI** | Android mobile "MOBAsmart" | `net10.0-android36.0` |
| **WebApp** | Blazor Server "MOBAdash" | `net10.0` |
| **Sound** | Audio/TTS functionality | `net10.0` |
| **Test** | Unit tests | `net10.0` |

### Dependency Flow
```
WinUI ‚Üí SharedUI ‚Üí Backend
MAUI ‚Üí SharedUI ‚Üí Backend
WebApp ‚Üí SharedUI ‚Üí Backend
```

---

## üìÅ File Organization

### ‚úÖ **One Class Per File**
- File name MUST match class name (e.g., `SystemState.cs`)
- ‚ùå **NEVER** put multiple public classes in one file

### ‚úÖ **Namespace Conventions**

**Rule:** Namespace MUST match RootNamespace + folder structure

```csharp
// ‚úÖ CORRECT: Namespace matches project structure
// File: Backend\Manager\JourneyManager.cs
namespace Moba.Backend.Manager;

// File: WinUI\Service\IoService.cs
namespace Moba.WinUI.Service;

// File: SharedUI\ViewModel\JourneyViewModel.cs
namespace Moba.SharedUI.ViewModel;
```

**RootNamespace per Project:**
| Project | RootNamespace | Example |
|---------|---------------|---------|
| Backend | `Moba.Backend` | `Moba.Backend.Manager` |
| SharedUI | `Moba.SharedUI` | `Moba.SharedUI.ViewModel` |
| WinUI | `Moba.WinUI` | `Moba.WinUI.Service` |
| MAUI | `Moba.MAUI` | `Moba.MAUI.Service` |
| WebApp | `Moba.WebApp` | `Moba.WebApp.Service` |
| Sound | `Moba.Sound` | `Moba.Sound` |

‚ö†Ô∏è **Note:** MAUI.csproj defines `<RootNamespace>Moba.Smart</RootNamespace>` but code uses `Moba.MAUI` for consistency with other projects.

### ‚úÖ **Using Directives**

**Always use absolute namespaces** for clarity and consistency:

```csharp
// ‚úÖ GOOD: Absolute namespace
using Moba.Backend.Model;
using Moba.SharedUI.Service;

// ‚ùå BAD: Relative namespace
using Backend.Model;  // Ambiguous!
```

### ‚úÖ **Use Sub-Namespaces for Organization**
```csharp
// ‚úÖ GOOD: Organized with sub-namespaces
namespace Moba.Backend.Manager;
namespace Moba.Backend.Model.Action;
namespace Moba.WinUI.Service;

// ‚ùå BAD: Flat structure
namespace Moba.Backend;  // All classes in one namespace
```

---

## üìÅ SharedUI Platform-specific subfolders

To keep platform-specific ViewModels organized while still residing in `SharedUI`, place platform adapters under these subfolders:

- `SharedUI/ViewModel/WinUI` - WinUI-specific ViewModel adapters that dispatch to `DispatcherQueue` and/or use WinUI services.
- `SharedUI/ViewModel/MAUI` - MAUI-specific ViewModel adapters that dispatch to `MainThread` and/or use MAUI services.

These adapters must remain thin: inherit from `SharedUI.ViewModel.*` base ViewModels and perform only UI-thread dispatching or platform service wiring.

Example:

```csharp
namespace Moba.SharedUI.ViewModel.WinUI;

public class JourneyViewModel : Moba.SharedUI.ViewModel.JourneyViewModel
{
    // WinUI dispatching only
}
```

Follow the project's file and namespace conventions when adding these adapters.

---

## üéØ Mandatory Pre-Flight Checks

**BEFORE implementing ANY feature request:**

1. ‚úÖ **Search Microsoft Learn** for official documentation
2. ‚úÖ **Check for known issues** in .NET 10 / MAUI 10 / WinUI 3
3. ‚úÖ **Propose alternatives** if technology is unstable
4. ‚úÖ **Wait for explicit approval** before coding

### Decision Gate
```
IF (technology is stable AND documented AND appropriate)
    THEN implement
ELSE
    PROPOSE alternatives AND wait for user decision
```

---

## üõ†Ô∏è Technology Constraints

### .NET 10 LTS (Final Release)
- ‚úÖ Production-ready (released May 20, 2025)
- ‚úÖ Visual Studio 2026 (18.x) required
- ‚úÖ Use C# 13 features where appropriate

### WinUI 3
- ‚úÖ Windows App SDK
- ‚ö†Ô∏è **No XAML Designer** ‚Üí Use XAML Hot Reload
- ‚úÖ Use **x:Bind** over **Binding**

### MAUI 10 (Final Release)
- ‚úÖ Production-ready for standard apps
- ‚úÖ Android API 36 stable
- ‚ö†Ô∏è **Foreground Services still unstable** ‚Üí Use native Android
- ‚ö†Ô∏è **Threading Rules CRITICAL!** ‚Üí See [docs/THREADING.md](docs/THREADING.md)

---

## üßµ Threading (CRITICAL for MAUI!)

‚ö†Ô∏è **Only Main Thread can modify UI properties!**

```csharp
// ‚ùå BAD: Background thread
private void OnUdpCallback(Data data)
{
    StatusText = "Received!";  // ‚ùå CRASH on Android!
}

// ‚úÖ GOOD: Dispatched to Main Thread
private void OnUdpCallback(Data data)
{
#if ANDROID || IOS || MACCATALYST || WINDOWS
    MainThread.BeginInvokeOnMainThread(() =>
    {
        StatusText = "Received!";  // ‚úÖ Safe
    });
#endif
}
```

üìÑ **Full Guidelines**: See [docs/THREADING.md](docs/THREADING.md)

---

## üöÄ Async/Await Patterns

### Key Rules:
- ‚úÖ Use `async` for I/O-bound work (network, file, database)
- ‚úÖ Suffix methods with `Async`
- ‚úÖ Use `ConfigureAwait(false)` in Backend (not in ViewModels)
- ‚ùå **NEVER** use `.Result` or `.Wait()` (causes deadlocks)
- ‚ùå **NEVER** use `async void` (except event handlers)

üìÑ **Full Guidelines**: See [docs/ASYNC-PATTERNS.md](docs/ASYNC-PATTERNS.md)

---

## üé® MVVM Pattern

- ‚úÖ Use **CommunityToolkit.Mvvm** (`ObservableObject`, `RelayCommand`)
- ‚úÖ **ALL** UI logic in ViewModels (never in code-behind)
- ‚úÖ ViewModels must be **testable** (no direct UI dependencies)

```csharp
public partial class MyViewModel : ObservableObject
{
    [ObservableProperty]
    private string title = "Default";

    [RelayCommand]
    private async Task DoSomethingAsync()
    {
        // Logic here
    }
}
```

---

## üé® UX & Usability Principles (CRITICAL!)

**Core Philosophy**: **"If users struggle, we failed - not them."**

All UI implementations must follow UX best practices for consistency, accessibility, and user satisfaction.

üìÑ **Full Guidelines**: See [docs/UX-GUIDELINES.md](docs/UX-GUIDELINES.md)

### **Quick Reference**

#### ‚úÖ **Key Principles**
1. **Responsive Design**: MaxWidth + Left alignment (no gaps on maximize)
2. **Spacing**: Use 4px grid (8, 12, 16, 24, 32)
3. **Feedback**: Show loading states, status text, progress
4. **Accessibility**: Keyboard navigation, screen readers, tooltips
5. **Consistency**: Use Segoe MDL2 icons, AccentButtonStyle, standard patterns
6. **Error Handling**: User-friendly messages + validation + confirmation dialogs
7. **Performance**: Virtualization for large lists, debouncing for search
8. **Touch**: Minimum 44x44 dp targets (MAUI)

#### ‚úÖ **Standard Patterns**
| Action | Pattern | Example |
|--------|---------|---------|
| **Primary Action** | AccentButtonStyle (blue) | Save, Connect, OK |
| **Destructive Action** | Red icon + confirmation | Delete, Clear All |
| **Cancel/Secondary** | Default style | Cancel, Close |
| **Navigation** | NavigationView | Explorer, Editor, Overview |
| **Notifications** | InfoBar | Success, Error, Warning |
| **Collapsible** | Expander | Settings groups |

#### ‚úÖ **UX Anti-Patterns to Avoid**
- ‚ùå No loading indicators ‚Üí ‚úÖ Show ProgressRing for >1s operations
- ‚ùå Cryptic errors ‚Üí ‚úÖ Explain problem + suggest solution
- ‚ùå Fixed width layouts ‚Üí ‚úÖ Responsive with MaxWidth
- ‚ùå No tooltips ‚Üí ‚úÖ Tooltip on every button
- ‚ùå No confirmation ‚Üí ‚úÖ ContentDialog for destructive actions

---

## üíâ Dependency Injection (DI) Conventions

### **Core Principle: Everything Through DI**

‚ö†Ô∏è **CRITICAL RULE**: **NEVER** use `new` for services, ViewModels, or application state!

```csharp
// ‚ùå WRONG: Direct instantiation
public class MainWindowViewModel
{
    public MainWindowViewModel()
    {
        Solution = new Solution();  // ‚ùå BAD!
        _z21 = new Z21();            // ‚ùå BAD!
    }
}

// ‚úÖ CORRECT: Constructor injection
public class MainWindowViewModel
{
    public MainWindowViewModel(
        IZ21 z21,                   // ‚úÖ Injected
        Solution solution)          // ‚úÖ Injected
    {
        _z21 = z21;
        Solution = solution;
    }
}
```

### **Solution Lifecycle Management**

**Rule:** `Solution` is registered as **Singleton** in all platforms (WinUI, MAUI, Blazor)

**Why Singleton?**
- ‚úÖ There is only **one active Solution** per application instance
- ‚úÖ All ViewModels share the **same instance** (shared state)
- ‚úÖ Changes are **immediately visible everywhere**
- ‚úÖ Represents the **central application state**

**DI Registration:**
```csharp
// WinUI: App.xaml.cs
services.AddSingleton<Backend.Model.Solution>(sp => new Backend.Model.Solution());

// MAUI: MauiProgram.cs
builder.Services.AddSingleton<Backend.Model.Solution>(sp => new Backend.Model.Solution());

// Blazor: Program.cs
builder.Services.AddSingleton<Moba.Backend.Model.Solution>(sp => new Moba.Backend.Model.Solution());
```

**Benefits:**
| Aspect | Without DI | With DI (Singleton) |
|--------|------------|---------------------|
| **Instantiation** | `new Solution()` in ViewModel | Injected by container |
| **Testability** | Hard to mock | Easy to replace with test double |
| **Consistency** | Inconsistent with other deps | All dependencies via DI |
| **Configuration** | Hardcoded | Centrally configurable |
| **Lifetime** | Per ViewModel instance | Shared across app |

**Why NOT Scoped or Transient?**
- ‚ùå **Scoped**: WinUI/MAUI don't have request scopes (Blazor concept)
- ‚ùå **Transient**: Would create multiple Solution instances ‚Üí data loss!
- ‚úÖ **Singleton**: Semantically correct for application-level state

### **ViewModel Factory Pattern**

All ViewModels that wrap models (Journey, Station, Workflow, etc.) must use **factory interfaces**:

```csharp
// ‚úÖ CORRECT: Factory creates platform-specific ViewModel
public interface IJourneyViewModelFactory
{
    JourneyViewModel Create(Journey model);
}

// Platform-specific implementation
public class WinUIJourneyViewModelFactory : IJourneyViewModelFactory
{
    private readonly IUiDispatcher _dispatcher;
    
    public WinUIJourneyViewModelFactory(IUiDispatcher dispatcher)
    {
        _dispatcher = dispatcher;
    }
    
    public JourneyViewModel Create(Journey model)
    {
        return new WinUI.ViewModel.JourneyViewModel(model, _dispatcher);
    }
}
```

**Register all factories:**
```csharp
services.AddSingleton<IJourneyViewModelFactory, WinUIJourneyViewModelFactory>();
services.AddSingleton<IStationViewModelFactory, WinUIStationViewModelFactory>();
services.AddSingleton<IWorkflowViewModelFactory, WinUIWorkflowViewModelFactory>();
// ... etc
```

### **DI Registration Checklist**

When adding a new service or ViewModel:

1. ‚úÖ **Register in ALL platforms** (WinUI, MAUI, Blazor)
2. ‚úÖ **Choose correct lifetime**:
   - Singleton: Application-wide state, expensive to create
   - Scoped: Per-request (Blazor only)
   - Transient: Stateless, cheap to create
3. ‚úÖ **Add to DI tests** (`Test/WinUI/WinUiDiTests.cs`, `Test/WebApp/WebAppDiTests.cs`)
4. ‚úÖ **Update unit test mocks** in `Test/TestBase/ViewModelTestBase.cs`

üìÑ **Full DI Guidelines**: See [docs/DI-INSTRUCTIONS.md](docs/DI-INSTRUCTIONS.md)

---

## üöÄ Pre-Flight Checklist

**Before committing code:**

**Build & Compilation:**
- [ ] ‚úÖ `run_build` ausgef√ºhrt ‚Üí gr√ºner Build
- [ ] ‚úÖ Keine Compiler-Warnungen
- [ ] ‚úÖ Alle `using`-Statements vorhanden
- [ ] ‚úÖ Test-Stubs angepasst bei Interface-√Ñnderungen

**Technical Checks:**
- [ ] Backend has NO platform-specific code (`#if WINDOWS`, `MainThread`, etc.)
- [ ] UI updates dispatched to Main Thread (MAUI) or DispatcherQueue (WinUI)
- [ ] All I/O operations use async/await
- [ ] No `.Result` or `.Wait()` on async code
- [ ] File names match class names
- [ ] Namespaces follow folder structure
- [ ] XML documentation in English
- [ ] Unit tests can run without UI framework

**UX/Usability Checks** (see UX Principles section):
- [ ] Responsive layout (no gaps on maximize)
- [ ] Loading states visible for async operations
- [ ] Error messages user-friendly and actionable
- [ ] Keyboard navigation works (Tab order, Ctrl+S, etc.)
- [ ] Tooltips on all interactive elements
- [ ] Confirmation dialogs for destructive actions
- [ ] Empty states guide users to next action
- [ ] Consistent spacing (multiples of 4px)
- [ ] Icons from Segoe MDL2 Assets
- [ ] Touch targets ‚â•44x44 dp (MAUI)
