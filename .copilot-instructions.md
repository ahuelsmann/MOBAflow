# ğŸš‚ Copilot Instructions for MOBAflow Project

**Quick Reference Guide** - See linked documents for detailed guidelines.

---

## ğŸŒ Communication Language

**Chat Language**: **Deutsch (German)**
- âœ… All chat conversations with the user should be conducted in **German**
- âœ… Code, documentation, and comments remain in **English**

---

## ğŸ“‹ Project Overview

**MOBAflow** - Model railroad control system built with .NET 10
- **Primary Platform**: Windows (WinUI 3) - "MOBAflow"
- **Secondary Platform**: Android (MAUI) - "MOBAsmart"  
- **Web Platform**: Blazor Server - "MOBAdash"
- **Target Hardware**: Z21 digital command station (UDP)

---

## ğŸ—ï¸ Architecture (MANDATORY!)

### **Core Principle: Keep Backend Platform-Independent**

âš ï¸ **CRITICAL RULE**: The `Backend` project MUST remain **100% platform-independent**!

- âŒ **NEVER** add UI thread dispatching to Backend (`DispatcherQueue`, `MainThread`, etc.)
- âœ… **ALWAYS** handle platform-specific threading in **platform-specific ViewModels**

```csharp
// âŒ WRONG: Dispatching in Backend
public class JourneyManager
{
#if WINDOWS
    await DispatchToUIThreadAsync(...);  // âŒ BAD!
#endif
}

// âœ… CORRECT: Platform-specific ViewModel handles dispatching
namespace Moba.WinUI.ViewModels.Journey;

public class JourneyViewModel : SharedUI.ViewModel.JourneyViewModel
{
    private readonly DispatcherQueue _dispatcher;
    // Handle UI thread dispatching here âœ…
}
```

ğŸ“„ **Full Guidelines**: See [docs/ARCHITECTURE.md](docs/ARCHITECTURE.md)

---

## ğŸ¨ Project Structure

| Project | Purpose | Target Framework |
|---------|---------|------------------|
| **Backend** | Z21 communication, business logic (platform-independent!) | `net10.0` |
| **SharedUI** | Base ViewModels, shared UI logic | `net10.0` |
| **WinUI** | Windows desktop "MOBAflow" | `net10.0-windows10.0.17763.0` |
| **MAUI** | Android mobile "MOBAsmart" | `net10.0-android36.0` |
| **WebApp** | Blazor Server "MOBAdash" | `net10.0` |
| **Sound** | Audio/TTS functionality | `net10.0` |
| **Test** | Unit tests | `net10.0` |

### Dependency Flow
```
WinUI â†’ SharedUI â†’ Backend
MAUI â†’ SharedUI â†’ Backend
WebApp â†’ SharedUI â†’ Backend
```

---

## ğŸ“ File Organization

### âœ… **One Class Per File**
- File name MUST match class name (e.g., `SystemState.cs`)
- âŒ **NEVER** put multiple public classes in one file

### âœ… **Use Sub-Namespaces for Organization**
```csharp
// âœ… GOOD: Organized with sub-namespaces
namespace Moba.WinUI.ViewModels.Journey;
namespace Moba.WinUI.Services;

// âŒ BAD: Flat structure
namespace Moba.WinUI.ViewModel;  // WinUIJourneyViewModel, WinUIMainWindowViewModel, etc.
```

---

## ğŸ“ SharedUI Platform-specific subfolders

To keep platform-specific ViewModels organized while still residing in `SharedUI`, place platform adapters under these subfolders:

- `SharedUI/ViewModel/WinUI` - WinUI-specific ViewModel adapters that dispatch to `DispatcherQueue` and/or use WinUI services.
- `SharedUI/ViewModel/MAUI` - MAUI-specific ViewModel adapters that dispatch to `MainThread` and/or use MAUI services.

These adapters must remain thin: inherit from `SharedUI.ViewModel.*` base ViewModels and perform only UI-thread dispatching or platform service wiring.

Example:

```csharp
namespace Moba.SharedUI.ViewModel.WinUI;

public class JourneyViewModel : Moba.SharedUI.ViewModel.JourneyViewModel
{
    // WinUI dispatching only
}
```

Follow the project's file and namespace conventions when adding these adapters.

---

## ğŸ”§ DI & Factories (MANDATORY)

- Register backend services via DI: `IZ21` (singleton), `IJourneyManagerFactory` (singleton)
- Use `IJourneyViewModelFactory` per platform to create `JourneyViewModel` adapters
- Never instantiate services or viewmodels with `new` in UI layers; resolve via DI/factory

---

## ğŸ¯ Mandatory Pre-Flight Checks

**BEFORE implementing ANY feature request:**

1. âœ… **Search Microsoft Learn** for official documentation
2. âœ… **Check for known issues** in .NET 10 / MAUI 10 / WinUI 3
3. âœ… **Propose alternatives** if technology is unstable
4. âœ… **Wait for explicit approval** before coding

### Decision Gate
```
IF (technology is stable AND documented AND appropriate)
    THEN implement
ELSE
    PROPOSE alternatives AND wait for user decision
```

---

## ğŸ› ï¸ Technology Constraints

### .NET 10 LTS (Final Release)
- âœ… Production-ready (released May 20, 2025)
- âœ… Visual Studio 2026 (18.x) required
- âœ… Use C# 13 features where appropriate

### WinUI 3
- âœ… Windows App SDK
- âš ï¸ **No XAML Designer** â†’ Use XAML Hot Reload
- âœ… Use **x:Bind** over **Binding**

### MAUI 10 (Final Release)
- âœ… Production-ready for standard apps
- âœ… Android API 36 stable
- âš ï¸ **Foreground Services still unstable** â†’ Use native Android
- âš ï¸ **Threading Rules CRITICAL!** â†’ See [docs/THREADING.md](docs/THREADING.md)

---

## ğŸ§µ Threading (CRITICAL for MAUI!)

âš ï¸ **Only Main Thread can modify UI properties!**

```csharp
// âŒ BAD: Background thread
private void OnUdpCallback(Data data)
{
    StatusText = "Received!";  // âŒ CRASH on Android!
}

// âœ… GOOD: Dispatched to Main Thread
private void OnUdpCallback(Data data)
{
#if ANDROID || IOS || MACCATALYST || WINDOWS
    MainThread.BeginInvokeOnMainThread(() =>
    {
        StatusText = "Received!";  // âœ… Safe
    });
#endif
}
```

ğŸ“„ **Full Guidelines**: See [docs/THREADING.md](docs/THREADING.md)

---

## ğŸš€ Async/Await Patterns

### Key Rules:
- âœ… Use `async` for I/O-bound work (network, file, database)
- âœ… Suffix methods with `Async`
- âœ… Use `ConfigureAwait(false)` in Backend (not in ViewModels)
- âŒ **NEVER** use `.Result` or `.Wait()` (causes deadlocks)
- âŒ **NEVER** use `async void` (except event handlers)

ğŸ“„ **Full Guidelines**: See [docs/ASYNC-PATTERNS.md](docs/ASYNC-PATTERNS.md)

---

## ğŸ¨ MVVM Pattern

- âœ… Use **CommunityToolkit.Mvvm** (`ObservableObject`, `RelayCommand`)
- âœ… **ALL** UI logic in ViewModels (never in code-behind)
- âœ… ViewModels must be **testable** (no direct UI dependencies)

```csharp
public partial class MyViewModel : ObservableObject
{
    [ObservableProperty]
    private string title = "Default";

    [RelayCommand]
    private async Task DoSomethingAsync()
    {
        // Logic here
    }
}
```

---

## ğŸ”Œ Z21 Hardware & Protocol

**Quick Reference:**
- ğŸ“¡ **Protocol**: UDP on port 21105
- ğŸ  **Default IP**: 192.168.0.111
- ğŸ“¦ **Implementation**: `Backend.Z21` class
- âš ï¸ **Thread Safety**: All events on background thread â†’ Use `MainThread.BeginInvokeOnMainThread()`
- ğŸ“„ **Specification**: [Z21 LAN Protocol V1.13 (PDF)](https://www.z21.eu/media/Kwc_Basic_DownloadTag_Component/47-1652-959-downloadTag/default/69bad87e/1699290251/z21-lan-protokoll.pdf)

### Track Feedback System:
- **InPorts**: Track occupancy detectors
- **Current Setup**: 3 parallel tracks â†’ InPorts 1, 2, 3
- **Use Case**: Lap counting (e.g., cleaning train runs)

---

## ğŸ“š Documentation Sources

### Primary Sources:
1. **Microsoft Learn** - https://learn.microsoft.com/dotnet/
2. **GitHub Issues** - .NET MAUI, WinUI, .NET
3. **NuGet Docs** - CommunityToolkit.Mvvm, CommunityToolkit.Maui, UraniumUI
4. **Z21 Protocol** - See PDF link above

### Search Strategy:
```
1. Search Microsoft Learn first
2. Check GitHub issues for known problems
3. Verify with NuGet package docs
4. Consult Z21 Protocol PDF for hardware details
5. Present findings to user BEFORE coding
```

---

## ğŸš¨ Known Issues

### .NET 10 / MAUI 10 Final:
- âš ï¸ **MAUI Foreground Services**: Still unstable â†’ Native Android implementation
- âš ï¸ **Shell Navigation**: Can be problematic â†’ Prefer `NavigationPage`
- âš ï¸ **Hot Reload with Source Generators**: May not update `ObservableProperty` â†’ Restart debugger

---

## ğŸ“– Detailed Documentation

- ğŸ“ [ARCHITECTURE.md](ARCHITECTURE.md) - Platform-independent Backend guidelines
- ğŸ§µ [docs/THREADING.md](docs/THREADING.md) - MAUI Threading (CRITICAL!)
- ğŸš€ [docs/ASYNC-PATTERNS.md](docs/ASYNC-PATTERNS.md) - Async/Await best practices

---

## âœ… Quick Checklist

**Before committing code:**

- [ ] Backend has NO platform-specific code (`#if WINDOWS`, `MainThread`, etc.)
- [ ] UI updates dispatched to Main Thread (MAUI) or DispatcherQueue (WinUI)
- [ ] All I/O operations use async/await
- [ ] No `.Result` or `.Wait()` on async code
- [ ] File names match class names
- [ ] XML documentation in English
- [ ] Unit tests can run without UI framework
