<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    x:Class="Moba.Smart.MainPage"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
    Title="MOBAsmart"
    BackgroundColor="{DynamicResource SurfaceBackground}">

    <ScrollView>
        <VerticalStackLayout Padding="12,8" Spacing="8">

            <!--  Header with Status Indicator  -->
            <Grid ColumnDefinitions="*,Auto" Margin="4,8,4,4">
                <VerticalStackLayout Grid.Column="0" Spacing="0" VerticalOptions="Center">
                    <Label
                        FontAttributes="Bold"
                        FontSize="24"
                        Text="MOBAsmart"
                        TextColor="{DynamicResource RailwayPrimary}" />
                    <Label
                        FontSize="11"
                        Text="Monitor"
                        TextColor="{DynamicResource TextSecondary}" />
                </VerticalStackLayout>
                <!--  Connection Status Dot  -->
                <Border
                    Grid.Column="1"
                    BackgroundColor="{Binding IsConnected, Converter={toolkit:BoolToObjectConverter TrueObject={StaticResource RailwayAccent}, FalseObject={StaticResource RailwayDanger}}}"
                    HeightRequest="14"
                    StrokeShape="RoundRectangle 7"
                    StrokeThickness="0"
                    VerticalOptions="Center"
                    WidthRequest="14">
                    <Border.Shadow>
                        <Shadow
                            Brush="{Binding IsConnected, Converter={toolkit:BoolToObjectConverter TrueObject={StaticResource RailwayAccent}, FalseObject={StaticResource RailwayDanger}}}"
                            Opacity="0.6"
                            Radius="8" />
                    </Border.Shadow>
                </Border>
            </Grid>

            <!--  Connection Controls Card  -->
            <Border
                Margin="0"
                Padding="12"
                Style="{DynamicResource FilledCard}">
                <VerticalStackLayout Spacing="10">
                    <!--  IP Address Entry with Icon  -->
                    <Border
                        Padding="10,8"
                        BackgroundColor="{DynamicResource SurfaceHighlight}"
                        StrokeShape="RoundRectangle 8"
                        StrokeThickness="0">
                        <Grid ColumnDefinitions="Auto,*" ColumnSpacing="10">
                            <Label
                                Grid.Column="0"
                                FontSize="16"
                                Text="ðŸŒ"
                                TextColor="{DynamicResource TextSecondary}"
                                VerticalOptions="Center" />
                            <Entry
                                Grid.Column="1"
                                FontSize="14"
                                Placeholder="192.168.0.111"
                                Text="{Binding Z21IpAddress}"
                                VerticalOptions="Center" />
                        </Grid>
                    </Border>

                    <!--  Connection & Track Power Toggles  -->
                    <Grid ColumnDefinitions="*,*" ColumnSpacing="8">
                        <!--  Connection Toggle  -->
                        <Border
                            Grid.Column="0"
                            Padding="10,5"
                            BackgroundColor="{DynamicResource SurfaceDark}"
                            StrokeShape="RoundRectangle 6"
                            StrokeThickness="0">
                            <Grid ColumnDefinitions="*,Auto" ColumnSpacing="8">
                                <Label
                                    Grid.Column="0"
                                    FontSize="12"
                                    Text="{Binding IsConnected, Converter={toolkit:BoolToObjectConverter TrueObject='Connected', FalseObject='Disconnected'}}"
                                    TextColor="{DynamicResource TextSecondary}"
                                    VerticalOptions="Center" />
                                <Switch
                                    x:Name="ConnectionSwitch"
                                    Grid.Column="1"
                                    IsToggled="{Binding IsConnected, Mode=OneWay}"
                                    OnColor="{DynamicResource RailwayAccent}"
                                    Scale="0.8"
                                    ThumbColor="White"
                                    Toggled="ConnectionSwitch_Toggled"
                                    VerticalOptions="Center" />
                            </Grid>
                        </Border>

                        <!--  Track Power Toggle  -->
                        <Border
                            Grid.Column="1"
                            Padding="10,5"
                            BackgroundColor="{DynamicResource SurfaceDark}"
                            StrokeShape="RoundRectangle 6"
                            StrokeThickness="0">
                            <Grid ColumnDefinitions="*,Auto" ColumnSpacing="8">
                                <Label
                                    Grid.Column="0"
                                    FontSize="12"
                                    Text="Track Power"
                                    TextColor="{DynamicResource TextSecondary}"
                                    VerticalOptions="Center" />
                                <Switch
                                    x:Name="TrackPowerSwitch"
                                    Grid.Column="1"
                                    IsEnabled="{Binding IsConnected}"
                                    IsToggled="{Binding IsTrackPowerOn, Mode=OneWay}"
                                    OnColor="{DynamicResource RailwayWarning}"
                                    Scale="0.8"
                                    ThumbColor="White"
                                    Toggled="TrackPowerSwitch_Toggled"
                                    VerticalOptions="Center" />
                            </Grid>
                        </Border>
                    </Grid>
                </VerticalStackLayout>
            </Border>

            <!--  Live Stats Bar (when connected)  -->
            <Border
                Margin="0"
                Padding="12,10"
                BackgroundColor="{DynamicResource SurfaceDark}"
                IsVisible="{Binding IsConnected}"
                StrokeShape="RoundRectangle 10"
                StrokeThickness="0">
                <Grid ColumnDefinitions="*,*,*" ColumnSpacing="8">
                    <!--  Temperature  -->
                    <HorizontalStackLayout Grid.Column="0" HorizontalOptions="Center" Spacing="6">
                        <Label FontSize="16" Text="ðŸŒ¡ï¸" VerticalOptions="Center" />
                        <Label
                            FontAttributes="Bold"
                            FontSize="14"
                            Text="{Binding Temperature, StringFormat='{0}Â°C'}"
                            TextColor="{DynamicResource TextPrimary}"
                            VerticalOptions="Center" />
                    </HorizontalStackLayout>
                    <!--  Supply Voltage  -->
                    <HorizontalStackLayout Grid.Column="1" HorizontalOptions="Center" Spacing="6">
                        <Label FontSize="16" Text="ðŸ”Œ" VerticalOptions="Center" />
                        <Label
                            FontAttributes="Bold"
                            FontSize="14"
                            Text="{Binding SupplyVoltage, StringFormat='{0}mV'}"
                            TextColor="{DynamicResource TextPrimary}"
                            VerticalOptions="Center" />
                    </HorizontalStackLayout>
                    <!--  VCC  -->
                    <HorizontalStackLayout Grid.Column="2" HorizontalOptions="Center" Spacing="6">
                        <Label FontSize="16" Text="âš¡" VerticalOptions="Center" />
                        <Label
                            FontAttributes="Bold"
                            FontSize="14"
                            Text="{Binding VccVoltage, StringFormat='{0}mV'}"
                            TextColor="{DynamicResource TextPrimary}"
                            VerticalOptions="Center" />
                    </HorizontalStackLayout>
                </Grid>
            </Border>

            <!--  Lap Counters Card  -->
            <Border
                Margin="0"
                Padding="12"
                Style="{DynamicResource ElevatedCard}">
                <VerticalStackLayout Spacing="8">
                    <Grid ColumnDefinitions="Auto,*,Auto">
                        <Label
                            Grid.Column="0"
                            FontSize="18"
                            Text="ðŸ"
                            VerticalOptions="Center" />
                        <Label
                            Grid.Column="1"
                            Margin="8,0,0,0"
                            Style="{DynamicResource TitleSmall}"
                            Text="Lap Counters"
                            VerticalOptions="Center" />
                        <Button
                            Grid.Column="2"
                            Padding="14,0"
                            BackgroundColor="{DynamicResource SurfaceHighlight}"
                            Command="{Binding ResetCountersCommand}"
                            FontSize="12"
                            HeightRequest="32"
                            Text="â†» Reset"
                            TextColor="{DynamicResource TextSecondary}"
                            VerticalOptions="Center" />
                    </Grid>

                    <!--  Counters List  -->
                    <CollectionView ItemsSource="{Binding Statistics}">
                        <CollectionView.ItemTemplate>
                            <DataTemplate>
                                <Border
                                    Margin="0,0,0,6"
                                    Padding="12,8"
                                    BackgroundColor="{DynamicResource SurfaceElevated}"
                                    StrokeShape="RoundRectangle 12"
                                    StrokeThickness="0">
                                    <Grid ColumnDefinitions="Auto,*" ColumnSpacing="12">
                                        <!--  Counter Badge (vertikal zentriert)  -->
                                        <Border
                                            Grid.Column="0"
                                            BackgroundColor="{Binding HasReceivedFirstLap, Converter={toolkit:BoolToObjectConverter TrueObject={StaticResource RailwayAccent}, FalseObject={StaticResource RailwayPrimary}}}"
                                            HeightRequest="36"
                                            StrokeShape="RoundRectangle 8"
                                            StrokeThickness="0"
                                            VerticalOptions="Center"
                                            WidthRequest="36">
                                            <Label
                                                FontAttributes="Bold"
                                                FontSize="16"
                                                HorizontalOptions="Center"
                                                Text="{Binding Count}"
                                                TextColor="White"
                                                VerticalOptions="Center" />
                                        </Border>

                                        <!--  Content (2 Rows)  -->
                                        <Grid
                                            Grid.Column="1"
                                            RowDefinitions="Auto,Auto"
                                            RowSpacing="2">
                                            <!--  Row 1: Track | Lap Time | @ Feedback Time  -->
                                            <Grid
                                                Grid.Row="0"
                                                ColumnDefinitions="Auto,Auto,Auto,*"
                                                ColumnSpacing="12">
                                                <!--  Track Name  -->
                                                <Label
                                                    Grid.Column="0"
                                                    FontAttributes="Bold"
                                                    FontSize="14"
                                                    Text="{Binding InPort, StringFormat='Track {0}'}"
                                                    VerticalOptions="Center" />
                                                <!--  Lap Time  -->
                                                <HorizontalStackLayout Grid.Column="1" Spacing="4" VerticalOptions="Center">
                                                    <Label
                                                        FontSize="11"
                                                        Text="Lap:"
                                                        TextColor="{DynamicResource TextDisabled}"
                                                        VerticalOptions="Center" />
                                                    <Label
                                                        FontAttributes="Bold"
                                                        FontSize="11"
                                                        Text="{Binding LastLapTimeFormatted}"
                                                        TextColor="{DynamicResource RailwaySecondary}"
                                                        VerticalOptions="Center" />
                                                </HorizontalStackLayout>
                                                <!--  Feedback Time  -->
                                                <HorizontalStackLayout Grid.Column="2" Spacing="4" VerticalOptions="Center">
                                                    <Label
                                                        FontSize="11"
                                                        Text="@"
                                                        TextColor="{DynamicResource TextDisabled}"
                                                        VerticalOptions="Center" />
                                                    <Label
                                                        FontSize="11"
                                                        Text="{Binding LastFeedbackTimeFormatted}"
                                                        TextColor="{DynamicResource TextDisabled}"
                                                        VerticalOptions="Center" />
                                                </HorizontalStackLayout>
                                            </Grid>

                                            <!--  Row 2: Lap Count (left) | Progress (right)  -->
                                            <Grid
                                                Grid.Row="1"
                                                ColumnDefinitions="Auto,*,Auto,Auto"
                                                ColumnSpacing="8">
                                                <!--  Lap Count  -->
                                                <Label
                                                    Grid.Column="0"
                                                    FontSize="11"
                                                    Text="{Binding LapCountFormatted}"
                                                    TextColor="{DynamicResource TextSecondary}"
                                                    VerticalOptions="Center" />
                                                <!--  Spacer  -->
                                                <BoxView Grid.Column="1" Color="Transparent" />
                                                <!--  Progress Bar  -->
                                                <ProgressBar
                                                    Grid.Column="2"
                                                    HeightRequest="5"
                                                    Progress="{Binding Progress}"
                                                    ProgressColor="{DynamicResource RailwayAccent}"
                                                    VerticalOptions="Center"
                                                    WidthRequest="60" />
                                                <!--  Progress Percentage  -->
                                                <Label
                                                    Grid.Column="3"
                                                    FontSize="10"
                                                    HorizontalTextAlignment="End"
                                                    Text="{Binding Progress, StringFormat='{0:P0}'}"
                                                    TextColor="{DynamicResource TextSecondary}"
                                                    VerticalOptions="Center"
                                                    WidthRequest="40" />
                                            </Grid>
                                        </Grid>
                                    </Grid>
                                </Border>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>
                </VerticalStackLayout>
            </Border>

            <!--  Footer  -->
            <Label
                Margin="0,4,0,8"
                FontSize="10"
                HorizontalOptions="Center"
                Text="Â© 2025 Andreas HÃ¼lsmann"
                TextColor="{DynamicResource TextDisabled}" />

        </VerticalStackLayout>
    </ScrollView>
</ContentPage>
