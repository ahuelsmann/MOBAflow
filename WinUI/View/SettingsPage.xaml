<Page
    x:Class="Moba.WinUI.View.SettingsPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    mc:Ignorable="d">

    <ScrollViewer>
        <StackPanel Padding="40,24,40,40" Spacing="8">

            <!--  Page Header with Dark Mode Toggle  -->
            <Grid Margin="0,0,0,8">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>

                <TextBlock
                    Grid.Column="0"
                    Style="{StaticResource TitleTextBlockStyle}"
                    Text="Settings" />
            </Grid>

            <!--  Z21 Connection Section  -->
            <Expander
                HorizontalAlignment="Stretch"
                HorizontalContentAlignment="Stretch"
                Header="Z21 Connection"
                IsExpanded="False">
                <Expander.HeaderTemplate>
                    <DataTemplate>
                        <StackPanel Orientation="Horizontal" Spacing="12">
                            <FontIcon FontSize="20" Glyph="&#xE8CE;" />
                            <TextBlock
                                VerticalAlignment="Center"
                                Style="{StaticResource SubtitleTextBlockStyle}"
                                Text="{Binding}" />
                        </StackPanel>
                    </DataTemplate>
                </Expander.HeaderTemplate>

                <StackPanel Padding="56,16,0,16" Spacing="16">
                    <TextBox
                        MaxWidth="400"
                        HorizontalAlignment="Left"
                        Header="IP Address"
                        PlaceholderText="192.168.0.111"
                        Text="{x:Bind ViewModel.IpAddress, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}">
                        <TextBox.Description>
                            <TextBlock Text="IP address of your Z21 digital command station" />
                        </TextBox.Description>
                    </TextBox>

                    <TextBox
                        MaxWidth="200"
                        HorizontalAlignment="Left"
                        Header="Port"
                        PlaceholderText="21105"
                        Text="{x:Bind ViewModel.Port, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}">
                        <TextBox.Description>
                            <TextBlock Text="Z21 communication port (default: 21105)" />
                        </TextBox.Description>
                    </TextBox>

                    <NumberBox
                        MaxWidth="200"
                        HorizontalAlignment="Left"
                        Header="Auto-Connect Retry Interval (seconds)"
                        Minimum="5"
                        SpinButtonPlacementMode="Inline"
                        Value="{x:Bind ViewModel.Z21AutoConnectRetryInterval, Mode=TwoWay}">
                        <NumberBox.Description>
                            <TextBlock Text="How often to attempt reconnection if Z21 is unreachable (5-60 seconds)" TextWrapping="Wrap" />
                        </NumberBox.Description>
                    </NumberBox>

                    <NumberBox
                        MaxWidth="200"
                        HorizontalAlignment="Left"
                        Header="System State Polling Interval (seconds)"
                        Minimum="5"
                        SpinButtonPlacementMode="Inline"
                        Value="{x:Bind ViewModel.Z21SystemStatePollingInterval, Mode=TwoWay}">
                        <NumberBox.Description>
                            <TextBlock Text="How often to request current, voltage, temperature updates (0 = disabled, 1-30 seconds)" TextWrapping="Wrap" />
                        </NumberBox.Description>
                    </NumberBox>
                </StackPanel>
            </Expander>

            <!--  City Library Section  -->
            <Expander
                HorizontalAlignment="Stretch"
                HorizontalContentAlignment="Stretch"
                Header="City Library"
                IsExpanded="False">
                <Expander.HeaderTemplate>
                    <DataTemplate>
                        <StackPanel Orientation="Horizontal" Spacing="12">
                            <FontIcon FontSize="20" Glyph="&#xE80F;" />
                            <TextBlock
                                VerticalAlignment="Center"
                                Style="{StaticResource SubtitleTextBlockStyle}"
                                Text="{Binding}" />
                        </StackPanel>
                    </DataTemplate>
                </Expander.HeaderTemplate>

                <StackPanel Padding="56,16,0,16" Spacing="16">
                    <StackPanel Spacing="4">
                        <TextBlock Style="{StaticResource BodyTextBlockStyle}" Text="Station Data File" />
                        <Grid ColumnSpacing="8">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="Auto" />
                            </Grid.ColumnDefinitions>

                            <TextBox
                                Grid.Column="0"
                                PlaceholderText="germany-stations.json"
                                Text="{x:Bind ViewModel.CityLibraryPath, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" />

                            <Button
                                Grid.Column="1"
                                VerticalAlignment="Stretch"
                                Command="{x:Bind ViewModel.BrowseCityLibraryCommand}"
                                ToolTipService.ToolTip="Browse for city library file">
                                <StackPanel Orientation="Horizontal" Spacing="8">
                                    <FontIcon FontSize="16" Glyph="&#xED25;" />
                                    <TextBlock Text="Browse" />
                                </StackPanel>
                            </Button>
                        </Grid>
                        <TextBlock
                            Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                            Style="{StaticResource CaptionTextBlockStyle}"
                            Text="Path to JSON file with city/station master data" />
                    </StackPanel>

                    <CheckBox Content="Auto-reload when file changes" IsChecked="{x:Bind ViewModel.CityLibraryAutoReload, Mode=TwoWay}" />
                </StackPanel>
            </Expander>

            <!--  Speech Synthesis Section  -->
            <Expander
                HorizontalAlignment="Stretch"
                HorizontalContentAlignment="Stretch"
                Header="Speech Synthesis"
                IsExpanded="False">
                <Expander.HeaderTemplate>
                    <DataTemplate>
                        <StackPanel Orientation="Horizontal" Spacing="12">
                            <FontIcon FontSize="20" Glyph="&#xE8BD;" />
                            <TextBlock
                                VerticalAlignment="Center"
                                Style="{StaticResource SubtitleTextBlockStyle}"
                                Text="{Binding}" />
                        </StackPanel>
                    </DataTemplate>
                </Expander.HeaderTemplate>

                <StackPanel Padding="56,16,0,16" Spacing="16">
                    <!--  Speech Engine Selection  -->
                    <ComboBox
                        MaxWidth="400"
                        HorizontalAlignment="Left"
                        Header="Speech Engine"
                        ItemsSource="{x:Bind ViewModel.AvailableSpeechEngines}"
                        SelectedItem="{x:Bind ViewModel.SelectedSpeechEngine, Mode=TwoWay}">
                        <ComboBox.ItemTemplate>
                            <DataTemplate>
                                <StackPanel Orientation="Horizontal" Spacing="8">
                                    <FontIcon FontSize="14" Glyph="&#xE8BD;" />
                                    <TextBlock Text="{Binding}" />
                                </StackPanel>
                            </DataTemplate>
                        </ComboBox.ItemTemplate>
                    </ComboBox>

                    <!--  Azure Settings (only shown when Azure engine selected)  -->
                    <StackPanel Spacing="16" Visibility="{x:Bind ViewModel.IsAzureSpeechEngineSelected, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}">
                        <TextBox
                            MaxWidth="500"
                            HorizontalAlignment="Left"
                            Header="Azure Speech Key"
                            PlaceholderText="Enter your Azure Speech API key"
                            Text="{x:Bind ViewModel.SpeechKey, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" />

                        <TextBox
                            MaxWidth="300"
                            HorizontalAlignment="Left"
                            Header="Azure Region"
                            PlaceholderText="germanywestcentral"
                            Text="{x:Bind ViewModel.SpeechRegion, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}">
                            <TextBox.Description>
                                <TextBlock Text="Azure region for Speech Service" />
                            </TextBox.Description>
                        </TextBox>
                    </StackPanel>

                    <NumberBox
                        MaxWidth="400"
                        HorizontalAlignment="Left"
                        Header="Speech Rate"
                        Maximum="10"
                        Minimum="-10"
                        SpinButtonPlacementMode="Inline"
                        Value="{x:Bind ViewModel.SpeechRate, Mode=TwoWay}">
                        <NumberBox.Description>
                            <TextBlock Text="Adjust speech speed (-10 = slowest, 0 = normal, 10 = fastest)" TextWrapping="Wrap" />
                        </NumberBox.Description>
                    </NumberBox>

                    <NumberBox
                        MaxWidth="400"
                        HorizontalAlignment="Left"
                        Header="Speech Volume"
                        Maximum="100"
                        Minimum="0"
                        SpinButtonPlacementMode="Inline"
                        Value="{x:Bind ViewModel.SpeechVolume, Mode=TwoWay}">
                        <NumberBox.Description>
                            <TextBlock Text="Adjust speech volume (0-100)" TextWrapping="Wrap" />
                        </NumberBox.Description>
                    </NumberBox>

                    <!--  Test Button  -->
                    <Button
                        Command="{x:Bind ViewModel.TestSpeechCommand}"
                        Content="Test Speech"
                        ToolTipService.ToolTip="Play a test announcement">
                        <Button.KeyboardAccelerators>
                            <KeyboardAccelerator Key="T" Modifiers="Control" />
                        </Button.KeyboardAccelerators>
                    </Button>
                </StackPanel>
            </Expander>

            <!--  REST API Section  -->
            <Expander
                HorizontalAlignment="Stretch"
                HorizontalContentAlignment="Stretch"
                Header="REST API"
                IsExpanded="False">
                <Expander.HeaderTemplate>
                    <DataTemplate>
                        <StackPanel Orientation="Horizontal" Spacing="12">
                            <FontIcon FontSize="20" Glyph="&#xE8BA;" />
                            <TextBlock
                                VerticalAlignment="Center"
                                Style="{StaticResource SubtitleTextBlockStyle}"
                                Text="{Binding}" />
                        </StackPanel>
                    </DataTemplate>
                </Expander.HeaderTemplate>

                <StackPanel Padding="56,16,0,16" Spacing="16">
                    <StackPanel>
                        <CheckBox Content="Auto-start REST API with MOBAflow" IsChecked="{x:Bind ViewModel.AutoStartWebApp, Mode=TwoWay}" />
                        <TextBlock
                            Margin="28,0,0,0"
                            Style="{StaticResource CaptionTextBlockStyle}"
                            Text="Starts an in-process for photo uploads from MOBAsmart"
                            TextWrapping="Wrap" />
                    </StackPanel>

                    <NumberBox
                        MaxWidth="200"
                        HorizontalAlignment="Left"
                        Header="Port"
                        Maximum="65535"
                        Minimum="1024"
                        SpinButtonPlacementMode="Inline"
                        Value="{x:Bind ViewModel.RestApiPort, Mode=TwoWay}">
                        <NumberBox.Description>
                            <TextBlock Text="Service port for photo upload (default: 5001)" TextWrapping="Wrap" />
                        </NumberBox.Description>
                    </NumberBox>

                    <!--  Local IP Address Display  -->
                    <StackPanel Spacing="4">
                        <TextBlock Style="{StaticResource BodyStrongTextBlockStyle}" Text="Local IP Address" />
                        <Grid ColumnSpacing="8">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="Auto" />
                            </Grid.ColumnDefinitions>
                            <TextBox
                                Grid.Column="0"
                                IsReadOnly="True"
                                Text="{x:Bind ViewModel.LocalIpAddress, Mode=OneWay}" />
                            <Button
                                Grid.Column="1"
                                VerticalAlignment="Stretch"
                                Click="CopyIpToClipboard_Click"
                                ToolTipService.ToolTip="Copy IP address to clipboard">
                                <FontIcon FontSize="16" Glyph="&#xE8C8;" />
                            </Button>
                        </Grid>
                        <TextBlock
                            Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                            Style="{StaticResource CaptionTextBlockStyle}"
                            Text="Use this IP address in MOBAsmart to connect to the REST API"
                            TextWrapping="Wrap" />
                    </StackPanel>
                </StackPanel>
            </Expander>

            <!--  Application Behavior Section  -->
            <Expander
                HorizontalAlignment="Stretch"
                HorizontalContentAlignment="Stretch"
                Header="Application Behavior"
                IsExpanded="False">
                <Expander.HeaderTemplate>
                    <DataTemplate>
                        <StackPanel Orientation="Horizontal" Spacing="12">
                            <FontIcon FontSize="20" Glyph="&#xF71C;" />
                            <TextBlock
                                VerticalAlignment="Center"
                                Style="{StaticResource SubtitleTextBlockStyle}"
                                Text="{Binding}" />
                        </StackPanel>
                    </DataTemplate>
                </Expander.HeaderTemplate>

                <StackPanel Padding="56,16,0,16" Spacing="16">
                    <StackPanel>
                        <CheckBox Content="Auto-load last solution" IsChecked="{x:Bind ViewModel.AutoLoadLastSolution, Mode=TwoWay}" />
                        <TextBlock
                            Margin="28,0,0,0"
                            Style="{StaticResource CaptionTextBlockStyle}"
                            Text="Automatically load the last opened solution on startup"
                            TextWrapping="Wrap" />
                    </StackPanel>
                </StackPanel>
            </Expander>

            <!--  Feedback Points Section  -->
            <Expander
                HorizontalAlignment="Stretch"
                HorizontalContentAlignment="Stretch"
                Header="Feedback Points"
                IsExpanded="False">
                <Expander.HeaderTemplate>
                    <DataTemplate>
                        <StackPanel Orientation="Horizontal" Spacing="12">
                            <FontIcon FontSize="20" Glyph="&#xE701;" />
                            <TextBlock
                                VerticalAlignment="Center"
                                Style="{StaticResource SubtitleTextBlockStyle}"
                                Text="{Binding}" />
                        </StackPanel>
                    </DataTemplate>
                </Expander.HeaderTemplate>

                <StackPanel Padding="56,16,0,16" Spacing="16">
                    <NumberBox
                        MaxWidth="200"
                        HorizontalAlignment="Left"
                        Header="Number of Feedback Points"
                        Minimum="0"
                        SpinButtonPlacementMode="Inline"
                        Value="{x:Bind ViewModel.CountOfFeedbackPoints, Mode=TwoWay}">
                        <NumberBox.Description>
                            <TextBlock TextWrapping="Wrap">
                                <Run Text="How many feedback points (InPorts) are in your track layout?" />
                                <LineBreak />
                                <Run Text="Example: 3 → Monitor will show InPorts 1, 2, 3" />
                                <LineBreak />
                                <Run FontStyle="Italic" Text="Note: Restart required to apply changes" />
                            </TextBlock>
                        </NumberBox.Description>
                    </NumberBox>
                </StackPanel>
            </Expander>

            <!--  Health Check Section  -->
            <Expander
                HorizontalAlignment="Stretch"
                HorizontalContentAlignment="Stretch"
                Header="Health Check"
                IsExpanded="False">
                <Expander.HeaderTemplate>
                    <DataTemplate>
                        <StackPanel Orientation="Horizontal" Spacing="12">
                            <FontIcon FontSize="20" Glyph="&#xE95E;" />
                            <TextBlock
                                VerticalAlignment="Center"
                                Style="{StaticResource SubtitleTextBlockStyle}"
                                Text="{Binding}" />
                        </StackPanel>
                    </DataTemplate>
                </Expander.HeaderTemplate>

                <StackPanel Padding="56,16,0,16" Spacing="16">
                    <CheckBox Content="Enable Z21 connection health checks" IsChecked="{x:Bind ViewModel.HealthCheckEnabled, Mode=TwoWay}" />

                    <NumberBox
                        Width="300"
                        HorizontalAlignment="Left"
                        Header="Health Check Interval (seconds)"
                        Minimum="5"
                        SpinButtonPlacementMode="Inline"
                        Value="{x:Bind ViewModel.HealthCheckIntervalSeconds, Mode=TwoWay}">
                        <NumberBox.Description>
                            <TextBlock Text="How often to check Z21 connection status" TextWrapping="Wrap" />
                        </NumberBox.Description>
                    </NumberBox>
                </StackPanel>
            </Expander>

            <!--  Feature Toggles Section  -->
            <Expander
                HorizontalAlignment="Stretch"
                HorizontalContentAlignment="Stretch"
                Header="Feature Toggles"
                IsExpanded="False">
                <Expander.HeaderTemplate>
                    <DataTemplate>
                        <StackPanel Orientation="Horizontal" Spacing="12">
                            <FontIcon FontSize="20" Glyph="&#xE7C8;" />
                            <TextBlock
                                VerticalAlignment="Center"
                                Style="{StaticResource SubtitleTextBlockStyle}"
                                Text="{Binding}" />
                        </StackPanel>
                    </DataTemplate>
                </Expander.HeaderTemplate>

                <StackPanel Padding="56,16,0,16" Spacing="12">
                    <TextBlock
                        Margin="0,0,0,8"
                        Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                        Style="{StaticResource CaptionTextBlockStyle}"
                        Text="Control which features are available in the application. Changes require app restart."
                        TextWrapping="Wrap" />

                    <!--  Core Features  -->
                    <TextBlock
                        Margin="0,8,0,4"
                        FontWeight="SemiBold"
                        Style="{StaticResource BodyStrongTextBlockStyle}"
                        Text="Core Features" />
                    <CheckBox Content="Overview Page" IsChecked="{x:Bind ViewModel.Settings.FeatureToggles.IsOverviewPageAvailable, Mode=TwoWay}" />
                    <CheckBox Content="Solution Page" IsChecked="{x:Bind ViewModel.Settings.FeatureToggles.IsSolutionPageAvailable, Mode=TwoWay}" />
                    <CheckBox Content="Settings Page" IsChecked="{x:Bind ViewModel.Settings.FeatureToggles.IsSettingsPageAvailable, Mode=TwoWay}" />

                    <!--  Journey Management  -->
                    <TextBlock
                        Margin="0,16,0,4"
                        FontWeight="SemiBold"
                        Style="{StaticResource BodyStrongTextBlockStyle}"
                        Text="Journey Management" />
                    <CheckBox Content="Journeys Page" IsChecked="{x:Bind ViewModel.Settings.FeatureToggles.IsJourneysPageAvailable, Mode=TwoWay}" />
                    <CheckBox Content="Workflows Page" IsChecked="{x:Bind ViewModel.Settings.FeatureToggles.IsWorkflowsPageAvailable, Mode=TwoWay}" />

                    <!--  Track Management (Experimental)  -->
                    <TextBlock
                        Margin="0,16,0,4"
                        FontWeight="SemiBold"
                        Style="{StaticResource BodyStrongTextBlockStyle}"
                        Text="Track Management (Experimental)" />

                    <CheckBox Content="{x:Bind ViewModel.TrackPlanEditorCheckBoxContent, Mode=OneWay}" IsChecked="{x:Bind ViewModel.Settings.FeatureToggles.IsTrackPlanEditorPageAvailable, Mode=TwoWay}">
                        <ToolTipService.ToolTip>
                            <TextBlock Text="Visual track layout designer (experimental)" />
                        </ToolTipService.ToolTip>
                    </CheckBox>

                    <CheckBox Content="{x:Bind ViewModel.JourneyMapCheckBoxContent, Mode=OneWay}" IsChecked="{x:Bind ViewModel.Settings.FeatureToggles.IsJourneyMapPageAvailable, Mode=TwoWay}">
                        <ToolTipService.ToolTip>
                            <TextBlock Text="Journey visualization map (experimental)" />
                        </ToolTipService.ToolTip>
                    </CheckBox>

                    <!--  Monitoring  -->
                    <TextBlock
                        Margin="0,16,0,4"
                        FontWeight="SemiBold"
                        Style="{StaticResource BodyStrongTextBlockStyle}"
                        Text="Monitoring &amp; Debugging" />

                    <CheckBox Content="{x:Bind ViewModel.MonitorCheckBoxContent, Mode=OneWay}" IsChecked="{x:Bind ViewModel.Settings.FeatureToggles.IsMonitorPageAvailable, Mode=TwoWay}">
                        <ToolTipService.ToolTip>
                            <TextBlock Text="Z21 traffic monitor and diagnostics" />
                        </ToolTipService.ToolTip>
                    </CheckBox>
                </StackPanel>
            </Expander>

            <!--  Save/Reset Buttons  -->
            <StackPanel
                Margin="0,24,0,0"
                HorizontalAlignment="Right"
                Orientation="Horizontal"
                Spacing="12">
                <Button Command="{x:Bind ViewModel.ResetToDefaultsCommand}" Content="Reset to Defaults" />
                <Button
                    Command="{x:Bind ViewModel.SaveSettingsCommand}"
                    Content="Save Settings"
                    Style="{StaticResource AccentButtonStyle}" />
            </StackPanel>

            <!--  Status Bar  -->
            <InfoBar
                Title="Settings Saved"
                Margin="0,16,0,0"
                IsClosable="True"
                IsOpen="{x:Bind ViewModel.ShowSuccessMessage, Mode=OneWay}"
                Message="Your settings have been saved successfully."
                Severity="Success" />

            <InfoBar
                Title="Error Saving Settings"
                Margin="0,8,0,0"
                IsClosable="True"
                IsOpen="{x:Bind ViewModel.ShowErrorMessage, Mode=OneWay}"
                Message="{x:Bind ViewModel.ErrorMessage, Mode=OneWay}"
                Severity="Error" />

        </StackPanel>
    </ScrollViewer>
</Page>