<Page
    x:Class="Moba.WinUI.View.TrackPlanPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:canvas="using:Microsoft.Graphics.Canvas.UI.Xaml">
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
            <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>
        <!--  Toolbar  -->
        <CommandBar
            Grid.Row="0"
            DefaultLabelPosition="Right"
            OverflowButtonVisibility="Auto">
            <AppBarButton
                x:Name="LoadTestPlanButton"
                Icon="Document"
                Label="Load Test Plan"
                ToolTipService.ToolTip="Lädt das Test-TrackPlanResult (WR+R9+G62+G239) wie im SVG-Test" />
            <AppBarButton
                x:Name="OpenSvgInBrowserButton"
                Icon="Globe"
                Label="SVG im Browser"
                ToolTipService.ToolTip="Exportiert dasselbe Test-Plan als SVG und öffnet im Browser (Vergleich)" />
            <AppBarButton Icon="Accept" Label="Validate" />
            <AppBarButton Icon="ZoomIn" Label="Fit" />
            <AppBarButton Icon="Zoom" Label="100%" />
            <AppBarSeparator />
            <AppBarToggleButton
                x:Name="SnapToggle"
                Icon="Trim"
                IsChecked="True"
                Label="Snap" />
            <AppBarButton
                x:Name="DisconnectButton"
                Icon="Remove"
                Label="Trennen"
                ToolTipService.ToolTip="Verbindungen des ausgewählten Gleises lösen (R)" />
            <AppBarToggleButton
                Icon="ViewAll"
                IsChecked="False"
                Label="Grid" />
            <AppBarToggleButton IsChecked="True" Label="Rulers">
                <AppBarToggleButton.Icon>
                    <SymbolIcon Symbol="Trim" />
                </AppBarToggleButton.Icon>
            </AppBarToggleButton>
            <AppBarToggleButton IsChecked="False" Label="Movable Ruler">
                <AppBarToggleButton.Icon>
                    <SymbolIcon Symbol="Rotate" />
                </AppBarToggleButton.Icon>
            </AppBarToggleButton>
            <AppBarToggleButton IsChecked="True" Label="Port Hover">
                <AppBarToggleButton.Icon>
                    <SymbolIcon Symbol="Highlight" />
                </AppBarToggleButton.Icon>
            </AppBarToggleButton>
            <AppBarButton Label="Rotate ←">
                <AppBarButton.Icon>
                    <SymbolIcon Symbol="Back" />
                </AppBarButton.Icon>
            </AppBarButton>
            <AppBarButton Label="Rotate →">
                <AppBarButton.Icon>
                    <SymbolIcon Symbol="Forward" />
                </AppBarButton.Icon>
            </AppBarButton>
            <AppBarButton Label="Reset Ruler">
                <AppBarButton.Icon>
                    <SymbolIcon Symbol="Home" />
                </AppBarButton.Icon>
            </AppBarButton>
            <AppBarSeparator />
            <AppBarButton Label="Opacity:" />
            <AppBarButton>
                <Slider
                    Width="120"
                    Margin="8,0"
                    Maximum="1.0"
                    Minimum="0.1"
                    Value="0.8" />
            </AppBarButton>
        </CommandBar>
        <!--  Main Content Grid  -->
        <Grid x:Name="MainGrid" Grid.Row="1">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="180" />
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="240" />
            </Grid.ColumnDefinitions>
            <!--  Left Panel: Toolbox  -->
            <Border
                Grid.Column="0"
                Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                BorderThickness="0,0,1,0">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="*" />
                    </Grid.RowDefinitions>
                    <TextBlock
                        Grid.Row="0"
                        Padding="16,12"
                        Style="{StaticResource SubtitleTextBlockStyle}"
                        Text="Piko A-Gleis" />
                    <ScrollViewer Grid.Row="1" Padding="8,0">
                        <StackPanel x:Name="ToolboxStackPanel" Spacing="4">
                            <!--  Toolbox is populated from PikoACatalog in OnLoaded  -->
                        </StackPanel>
                    </ScrollViewer>
                </Grid>
            </Border>
            <!--  Center: Canvas with Pan/Zoom  -->
            <Border Grid.Column="1" Background="{ThemeResource SolidBackgroundFillColorBaseAltBrush}">
                <Grid>
                    <ScrollViewer
                        x:Name="CanvasScrollViewer"
                        HorizontalScrollBarVisibility="Auto"
                        HorizontalScrollMode="Enabled"
                        MaxZoomFactor="3.0"
                        MinZoomFactor="0.1"
                        VerticalScrollBarVisibility="Auto"
                        VerticalScrollMode="Enabled"
                        ZoomMode="Enabled">
                        <Grid Width="3000" Height="2000">
                            <canvas:CanvasControl
                                x:Name="GraphCanvasControl"
                                Width="3000"
                                Height="2000"
                                Background="{ThemeResource SolidBackgroundFillColorBaseBrush}"
                                CreateResources="GraphCanvasControl_CreateResources"
                                Draw="GraphCanvasControl_Draw" />
                            <Canvas
                                x:Name="OverlayCanvas"
                                Width="3000"
                                Height="2000"
                                AllowDrop="True"
                                Background="Transparent" />
                        </Grid>
                    </ScrollViewer>
                    <!--  Zoom Control Overlay (Bottom-Right)  -->
                    <StackPanel
                        Margin="0,0,12,12"
                        Padding="12,8"
                        HorizontalAlignment="Right"
                        VerticalAlignment="Bottom"
                        Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                        BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                        BorderThickness="1"
                        CornerRadius="6"
                        Orientation="Horizontal"
                        Spacing="8">
                        <Button
                            x:Name="ZoomOutButton"
                            Width="32"
                            Height="32"
                            Content="−"
                            FontSize="16"
                            ToolTipService.ToolTip="Zoom Out (Ctrl+−)" />
                        <Slider
                            x:Name="ZoomSlider"
                            Width="120"
                            VerticalAlignment="Center"
                            Maximum="3.0"
                            Minimum="0.1"
                            Value="1.0" />
                        <Button
                            x:Name="ZoomInButton"
                            Width="32"
                            Height="32"
                            Content="+"
                            FontSize="16"
                            ToolTipService.ToolTip="Zoom In (Ctrl++)" />
                        <TextBlock
                            x:Name="ZoomPercentText"
                            Width="50"
                            VerticalAlignment="Center"
                            Text="100%"
                            TextAlignment="Center" />
                    </StackPanel>
                </Grid>
            </Border>
            <!--  Right Panel: Properties  -->
            <Border
                Grid.Column="2"
                Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                BorderThickness="1,0,0,0">
                <ScrollViewer Padding="16">
                    <StackPanel Spacing="16">
                        <!--  Selection Info  -->
                        <StackPanel Spacing="8">
                            <TextBlock Style="{StaticResource SubtitleTextBlockStyle}" Text="Selection" />
                            <TextBlock
                                x:Name="SelectionInfoText"
                                Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                Text="No selection"
                                TextWrapping="Wrap" />
                        </StackPanel>
                        <!--  Properties Panel  -->
                        <StackPanel Spacing="12" Visibility="Collapsed">
                            <TextBlock Style="{StaticResource BodyStrongTextBlockStyle}" Text="Properties" />
                            <TextBox Header="Track ID" IsReadOnly="True" />
                            <TextBox Header="Template" IsReadOnly="True" />
                            <NumberBox Header="Position X (mm)" />
                            <NumberBox Header="Position Y (mm)" />
                            <NumberBox
                                Header="Rotation (deg)"
                                Maximum="360"
                                Minimum="0"
                                SmallChange="15" />
                            <NumberBox
                                Header="Feedback Point"
                                Minimum="0"
                                PlaceholderText="None" />
                            <Button
                                Margin="0,8,4,0"
                                Content="Disconnect"
                                ToolTipService.ToolTip="Disconnect (R)" />
                            <Button
                                Margin="0,8,0,0"
                                Content="Delete"
                                Style="{ThemeResource AccentButtonStyle}"
                                ToolTipService.ToolTip="Delete (D/Del)" />
                        </StackPanel>
                        <!--  Sections (Blocks)  -->
                        <StackPanel Spacing="8">
                            <TextBlock Style="{StaticResource BodyStrongTextBlockStyle}" Text="Sections" />
                            <TextBlock
                                Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                Text="No section assigned"
                                TextWrapping="Wrap" />
                            <StackPanel Orientation="Horizontal" Spacing="8">
                                <Button Content="Create Section" IsEnabled="False" />
                                <Button Content="Toggle Isolator" IsEnabled="False" />
                            </StackPanel>
                            <!--  Section Editor  -->
                            <StackPanel Spacing="8" Visibility="Collapsed">
                                <TextBox Header="Section Name" PlaceholderText="Enter section name" />
                                <ComboBox HorizontalAlignment="Stretch" Header="Function">
                                    <ComboBoxItem Content="Strecke" Tag="Track" />
                                    <ComboBoxItem Content="Bahnhof" Tag="Station" />
                                    <ComboBoxItem Content="Abstellgleis" Tag="Siding" />
                                    <ComboBoxItem Content="Rangiergleis" Tag="Shunting" />
                                    <ComboBoxItem Content="Hauptgleis" Tag="Main" />
                                    <ComboBoxItem Content="Nebengleis" Tag="Branch" />
                                </ComboBox>
                                <StackPanel>
                                    <TextBlock Margin="0,0,0,4" Text="Color" />
                                    <StackPanel Orientation="Horizontal" Spacing="4">
                                        <Button
                                            Width="28"
                                            Height="28"
                                            Padding="0"
                                            Background="{StaticResource TrackPlanSectionColor1}"
                                            CornerRadius="4"
                                            Tag="#FF5733" />
                                        <Button
                                            Width="28"
                                            Height="28"
                                            Padding="0"
                                            Background="{StaticResource TrackPlanSectionColor2}"
                                            CornerRadius="4"
                                            Tag="#33FF57" />
                                        <Button
                                            Width="28"
                                            Height="28"
                                            Padding="0"
                                            Background="{StaticResource TrackPlanSectionColor3}"
                                            CornerRadius="4"
                                            Tag="#3357FF" />
                                        <Button
                                            Width="28"
                                            Height="28"
                                            Padding="0"
                                            Background="{StaticResource TrackPlanSectionColor4}"
                                            CornerRadius="4"
                                            Tag="#FFFF33" />
                                        <Button
                                            Width="28"
                                            Height="28"
                                            Padding="0"
                                            Background="{StaticResource TrackPlanSectionColor5}"
                                            CornerRadius="4"
                                            Tag="#FF33FF" />
                                        <Button
                                            Width="28"
                                            Height="28"
                                            Padding="0"
                                            Background="{StaticResource TrackPlanSectionColor6}"
                                            CornerRadius="4"
                                            Tag="#33FFFF" />
                                        <Button
                                            Width="28"
                                            Height="28"
                                            Padding="0"
                                            Background="{StaticResource TrackPlanSectionColor7}"
                                            CornerRadius="4"
                                            Tag="#FF9933" />
                                        <Button
                                            Width="28"
                                            Height="28"
                                            Padding="0"
                                            Background="{StaticResource TrackPlanSectionColor8}"
                                            CornerRadius="4"
                                            Tag="#9933FF" />
                                    </StackPanel>
                                </StackPanel>
                                <Button Content="Delete Section" Style="{ThemeResource AccentButtonStyle}" />
                            </StackPanel>
                            <ListView MaxHeight="120">
                                <ListView.ItemTemplate>
                                    <DataTemplate>
                                        <Grid Padding="4" ColumnSpacing="8">
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="16" />
                                                <ColumnDefinition Width="*" />
                                                <ColumnDefinition Width="Auto" />
                                            </Grid.ColumnDefinitions>
                                            <Ellipse
                                                Grid.Column="0"
                                                Width="12"
                                                Height="12"
                                                Fill="{Binding Color}" />
                                            <TextBlock
                                                Grid.Column="1"
                                                VerticalAlignment="Center"
                                                Text="{Binding Name}" />
                                            <TextBlock
                                                Grid.Column="2"
                                                Foreground="{ThemeResource TextFillColorTertiaryBrush}"
                                                Text="{Binding TrackCount}" />
                                        </Grid>
                                    </DataTemplate>
                                </ListView.ItemTemplate>
                            </ListView>
                        </StackPanel>
                        <!--  Statistics  -->
                        <StackPanel Spacing="8">
                            <TextBlock Style="{StaticResource BodyStrongTextBlockStyle}" Text="Statistics" />
                            <Grid ColumnSpacing="8" RowSpacing="4">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*" />
                                    <ColumnDefinition Width="Auto" />
                                </Grid.ColumnDefinitions>
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto" />
                                    <RowDefinition Height="Auto" />
                                    <RowDefinition Height="Auto" />
                                    <RowDefinition Height="Auto" />
                                </Grid.RowDefinitions>
                                <TextBlock
                                    Grid.Row="0"
                                    Grid.Column="0"
                                    Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                    Text="Tracks:" />
                                <TextBlock
                                    x:Name="NodeCountText"
                                    Grid.Row="0"
                                    Grid.Column="1"
                                    Text="0" />
                                <TextBlock
                                    Grid.Row="1"
                                    Grid.Column="0"
                                    Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                    Text="Connections:" />
                                <TextBlock
                                    x:Name="EdgeCountText"
                                    Grid.Row="1"
                                    Grid.Column="1"
                                    Text="0" />
                                <TextBlock
                                    Grid.Row="2"
                                    Grid.Column="0"
                                    Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                    Text="Open Ends:" />
                                <TextBlock
                                    x:Name="EndcapCountText"
                                    Grid.Row="2"
                                    Grid.Column="1"
                                    Text="0" />
                                <TextBlock
                                    Grid.Row="3"
                                    Grid.Column="0"
                                    Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                    Text="Zoom:" />
                                <TextBlock
                                    x:Name="ZoomLevelText"
                                    Grid.Row="3"
                                    Grid.Column="1"
                                    Text="100%" />
                            </Grid>
                        </StackPanel>
                    </StackPanel>
                </ScrollViewer>
            </Border>
        </Grid>
        <!--  Status Bar  -->
        <Border
            Grid.Row="2"
            Padding="16,8"
            Background="{ThemeResource CardBackgroundFillColorSecondaryBrush}"
            BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
            BorderThickness="0,1,0,0">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>
                <TextBlock
                    x:Name="StatusText"
                    Grid.Column="0"
                    Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                    Text="Ready. Drag tracks from toolbox to canvas." />
                <TextBlock
                    x:Name="CoordinatesText"
                    Grid.Column="1"
                    Foreground="{ThemeResource TextFillColorTertiaryBrush}"
                    Text="X: 0  Y: 0" />
            </Grid>
        </Border>
    </Grid>
</Page>