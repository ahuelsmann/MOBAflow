<Page
x:Class="Moba.WinUI.View.TrackPlanPage"
xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
xmlns:vm="using:Moba.SharedUI.ViewModel"
mc:Ignorable="d">

<Grid>
    <Grid.RowDefinitions>
        <RowDefinition Height="Auto" />
        <RowDefinition Height="*" />
        <RowDefinition Height="Auto" />
        <RowDefinition Height="Auto" />
    </Grid.RowDefinitions>

    <!--  Page Header with Toolbar  -->
    <Grid Grid.Row="0" Padding="24,16">
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="*" />
            <ColumnDefinition Width="Auto" />
        </Grid.ColumnDefinitions>

        <!--  Title  -->
        <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="12">
            <FontIcon FontSize="24" Glyph="&#xE809;" />
            <StackPanel>
                <TextBlock Style="{StaticResource TitleTextBlockStyle}" Text="Track Plan" />
                <TextBlock
                    Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                    Style="{StaticResource CaptionTextBlockStyle}"
                    Text="{x:Bind ViewModel.TrackSystemInfo, Mode=OneWay}" />
            </StackPanel>
        </StackPanel>

        <!--  Toolbar  -->
        <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="8">
            <Button Command="{x:Bind ViewModel.BrowseAndLoadAnyRailLayoutCommand}" ToolTipService.ToolTip="Import AnyRail XML layout">
                <StackPanel Orientation="Horizontal" Spacing="8">
                    <FontIcon FontSize="16" Glyph="&#xE8E5;" />
                    <TextBlock Text="Import AnyRail" />
                </StackPanel>
            </Button>
        </StackPanel>
    </Grid>

    <!--  Main Content: Track Plan + Segment Details  -->
    <Grid Grid.Row="1" Margin="24,0">
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="*" />
            <ColumnDefinition Width="Auto" />
        </Grid.ColumnDefinitions>

            <!--  Track Plan Canvas  -->
            <Border
                Grid.Column="0"
                Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                CornerRadius="8">
                <Viewbox Margin="16" Stretch="Uniform">
                    <Canvas
                        x:Name="TrackCanvas"
                        Width="{x:Bind ViewModel.CanvasWidth, Mode=OneWay}"
                        Height="{x:Bind ViewModel.CanvasHeight, Mode=OneWay}"
                        Background="Transparent"
                        PointerPressed="TrackCanvas_PointerPressed">

                        <!--  Track Segments  -->
                        <ItemsControl ItemsSource="{x:Bind ViewModel.Segments, Mode=OneWay}">
                            <ItemsControl.ItemsPanel>
                                <ItemsPanelTemplate>
                                    <Canvas />
                                </ItemsPanelTemplate>
                            </ItemsControl.ItemsPanel>
                            <ItemsControl.ItemTemplate>
                                <DataTemplate x:DataType="vm:TrackSegmentViewModel">
                                    <Canvas PointerPressed="Segment_PointerPressed">
                                        <!--  Track Path  -->
                                        <Path
                                            Data="{x:Bind PathData, Mode=OneWay}"
                                            Stroke="{ThemeResource TextFillColorPrimaryBrush}"
                                            StrokeEndLineCap="Round"
                                            StrokeLineJoin="Round"
                                            StrokeStartLineCap="Round"
                                            StrokeThickness="{x:Bind StrokeThickness, Mode=OneWay}" />

                                        <!--  Selection Highlight (overlay)  -->
                                        <Path
                                            Data="{x:Bind PathData, Mode=OneWay}"
                                            Opacity="0.5"
                                            Stroke="{ThemeResource AccentFillColorDefaultBrush}"
                                            StrokeEndLineCap="Round"
                                            StrokeLineJoin="Round"
                                            StrokeStartLineCap="Round"
                                            StrokeThickness="8"
                                            Visibility="{x:Bind IsSelected, Mode=OneWay}" />

                                        <!--  Triggered State (feedback active)  -->
                                        <Path
                                            Data="{x:Bind PathData, Mode=OneWay}"
                                            Opacity="0.7"
                                            Stroke="#FF4444"
                                            StrokeEndLineCap="Round"
                                            StrokeLineJoin="Round"
                                            StrokeStartLineCap="Round"
                                            StrokeThickness="10"
                                            Visibility="{x:Bind IsTriggered, Mode=OneWay}" />

                                        <!--  InPort Label (if assigned)  -->
                                        <Border
                                            Canvas.Left="{x:Bind CenterX, Mode=OneWay}"
                                            Canvas.Top="{x:Bind CenterY, Mode=OneWay}"
                                            Padding="4,2"
                                            Background="{ThemeResource AccentFillColorDefaultBrush}"
                                            CornerRadius="4"
                                            Visibility="{x:Bind HasInPort, Mode=OneWay}">
                                            <TextBlock
                                                FontSize="10"
                                                FontWeight="Bold"
                                                Foreground="White"
                                                Text="{x:Bind InPortDisplayText, Mode=OneWay}" />
                                        </Border>
                                    </Canvas>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </Canvas>
                </Viewbox>
            </Border>

            <!--  Segment Details Panel (always visible)  -->
            <Border
                Grid.Column="1"
                Width="280"
                Margin="16,0,0,0"
                Padding="16"
                Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                CornerRadius="8">
                <StackPanel Spacing="16">
                    <!--  Header  -->
                    <TextBlock Style="{StaticResource SubtitleTextBlockStyle}" Text="Segment Details" />

                    <!--  No Selection Placeholder  -->
                    <TextBlock
                        Foreground="{ThemeResource TextFillColorTertiaryBrush}"
                        Text="Select a track segment to view details"
                        TextWrapping="Wrap"
                        Visibility="{x:Bind ViewModel.HasSelectedSegment, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}, ConverterParameter=Invert}" />

                    <!--  Segment Info (visible when selected)  -->
                    <StackPanel Spacing="8" Visibility="{x:Bind ViewModel.HasSelectedSegment, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}">
                        <TextBlock Foreground="{ThemeResource TextFillColorSecondaryBrush}" Text="Typ" />
                        <TextBlock FontWeight="SemiBold" Text="{x:Bind ViewModel.SelectedSegment.Name, Mode=OneWay}" />

                        <TextBlock
                            Margin="0,8,0,0"
                            Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                            Text="Gleis-Code (ID)" />
                        <TextBlock FontWeight="SemiBold" Text="{x:Bind ViewModel.SelectedSegment.ArticleCode, Mode=OneWay}" />

                        <TextBlock
                            Margin="0,8,0,0"
                            Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                            Text="Layer" />
                        <TextBlock Text="{x:Bind ViewModel.SelectedSegment.Layer, Mode=OneWay}" />

                        <Rectangle
                            Height="1"
                            Margin="0,16"
                            Fill="{ThemeResource DividerStrokeColorDefaultBrush}" />

                        <!--  InPort Assignment  -->
                        <TextBlock
                            FontWeight="SemiBold"
                            Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                            Text="Feedback Sensor" />

                        <NumberBox
                            Margin="0,8,0,0"
                            Header="InPort"
                            Maximum="2048"
                            Minimum="1"
                            PlaceholderText="1-2048"
                            SpinButtonPlacementMode="Inline"
                            Value="{x:Bind ViewModel.InPortInput, Mode=TwoWay}" />

                        <StackPanel
                            Margin="0,8,0,0"
                            Orientation="Horizontal"
                            Spacing="8">
                            <Button
                                Command="{x:Bind ViewModel.AssignInPortCommand}"
                                Content="Assign"
                                Style="{StaticResource AccentButtonStyle}" />
                            <Button Command="{x:Bind ViewModel.ClearInPortCommand}" Content="Clear" />
                        </StackPanel>

                        <!--  Current Assignment Info  -->
                        <Border
                            Margin="0,16,0,0"
                            Padding="12"
                            Background="{ThemeResource SystemFillColorSuccessBackgroundBrush}"
                            CornerRadius="4"
                            Visibility="{x:Bind ViewModel.SelectedSegment.HasInPort, Mode=OneWay}">
                            <StackPanel Orientation="Horizontal" Spacing="8">
                                <FontIcon
                                    FontSize="16"
                                    Foreground="{ThemeResource SystemFillColorSuccessBrush}"
                                    Glyph="&#xE73E;" />
                                <TextBlock Text="Assigned:" />
                                <TextBlock FontWeight="Bold" Text="{x:Bind ViewModel.SelectedSegment.InPortDisplayText, Mode=OneWay}" />
                            </StackPanel>
                        </Border>
                    </StackPanel>
                </StackPanel>
            </Border>
        </Grid>

        <!--  Journey Map Section  -->
        <Border
            Grid.Row="2"
            Margin="24,16,24,0"
            Padding="16"
            Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
            CornerRadius="8">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="Auto" />
                </Grid.RowDefinitions>

                <!--  Journey Selector  -->
                <StackPanel
                    Grid.Row="0"
                    Margin="0,0,0,12"
                    Orientation="Horizontal"
                    Spacing="16">
                    <FontIcon
                        VerticalAlignment="Center"
                        FontSize="16"
                        Foreground="{ThemeResource AccentFillColorDefaultBrush}"
                        Glyph="&#xE81D;" />
                    <TextBlock
                        VerticalAlignment="Center"
                        Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                        Text="Journey:" />
                    <ComboBox
                        MinWidth="200"
                        ItemsSource="{x:Bind ViewModel.AvailableJourneys, Mode=OneWay}"
                        SelectedItem="{x:Bind ViewModel.SelectedJourney, Mode=TwoWay}">
                        <ComboBox.ItemTemplate>
                            <DataTemplate x:DataType="vm:JourneyViewModel">
                                <TextBlock Text="{x:Bind Name, Mode=OneWay}" />
                            </DataTemplate>
                        </ComboBox.ItemTemplate>
                    </ComboBox>
                </StackPanel>

                <!--  Route Visualization  -->
                <ScrollViewer
                    Grid.Row="1"
                    HorizontalScrollBarVisibility="Auto"
                    VerticalScrollBarVisibility="Disabled"
                    Visibility="{x:Bind ViewModel.HasSelectedJourney, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}">
                    <Grid VerticalAlignment="Center">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto" />
                            <RowDefinition Height="Auto" />
                        </Grid.RowDefinitions>

                        <!--  Station Names (Top)  -->
                        <ItemsControl
                            Grid.Row="0"
                            Margin="0,0,0,8"
                            ItemsSource="{x:Bind ViewModel.RouteStations, Mode=OneWay}">
                            <ItemsControl.ItemsPanel>
                                <ItemsPanelTemplate>
                                    <StackPanel Orientation="Horizontal" Spacing="0" />
                                </ItemsPanelTemplate>
                            </ItemsControl.ItemsPanel>
                            <ItemsControl.ItemTemplate>
                                <DataTemplate x:DataType="vm:StationViewModel">
                                    <TextBlock
                                        Width="100"
                                        FontSize="11"
                                        FontWeight="{x:Bind IsCurrentStation, Mode=OneWay, Converter={StaticResource BoolToFontWeightConverter}}"
                                        Foreground="{x:Bind IsCurrentStation, Mode=OneWay, Converter={StaticResource BoolToAccentBrushConverter}}"
                                        Text="{x:Bind Name, Mode=OneWay}"
                                        TextAlignment="Center"
                                        TextTrimming="CharacterEllipsis"
                                        TextWrapping="NoWrap" />
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>

                        <!--  Track Line with Station Dots  -->
                        <ItemsControl Grid.Row="1" ItemsSource="{x:Bind ViewModel.RouteStations, Mode=OneWay}">
                            <ItemsControl.ItemsPanel>
                                <ItemsPanelTemplate>
                                    <StackPanel Orientation="Horizontal" Spacing="0" />
                                </ItemsPanelTemplate>
                            </ItemsControl.ItemsPanel>
                            <ItemsControl.ItemTemplate>
                                <DataTemplate x:DataType="vm:StationViewModel">
                                    <Grid Width="100" Height="32">
                                        <!--  Track segment (line to next station)  -->
                                        <Rectangle
                                            Height="3"
                                            HorizontalAlignment="Stretch"
                                            VerticalAlignment="Center"
                                            Fill="{ThemeResource ControlStrongStrokeColorDefaultBrush}" />

                                        <!--  Station dot  -->
                                        <Ellipse
                                            Width="16"
                                            Height="16"
                                            HorizontalAlignment="Center"
                                            VerticalAlignment="Center"
                                            Fill="{x:Bind IsCurrentStation, Mode=OneWay, Converter={StaticResource BoolToAccentBrushConverter}}"
                                            Stroke="{ThemeResource ControlStrongStrokeColorDefaultBrush}"
                                            StrokeThickness="2" />

                                        <!--  Train icon on current station  -->
                                        <FontIcon
                                            HorizontalAlignment="Center"
                                            VerticalAlignment="Center"
                                            FontSize="10"
                                            Foreground="White"
                                            Glyph="&#xE7C1;"
                                            Visibility="{x:Bind IsCurrentStation, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}" />
                                    </Grid>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </Grid>
                </ScrollViewer>

                <!--  No Journey Selected Placeholder  -->
                <TextBlock
                    Grid.Row="1"
                    Foreground="{ThemeResource TextFillColorTertiaryBrush}"
                    Text="Select a journey to see route progress"
                    Visibility="{x:Bind ViewModel.HasSelectedJourney, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}, ConverterParameter=Invert}" />
            </Grid>
        </Border>

        <!--  Status Bar  -->
        <Grid
            Grid.Row="3"
            Padding="24,12"
            Background="{ThemeResource CardBackgroundFillColorSecondaryBrush}"
            ColumnSpacing="24">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto" />
                <ColumnDefinition Width="Auto" />
                <ColumnDefinition Width="Auto" />
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="Auto" />
            </Grid.ColumnDefinitions>

            <!--  Current Station  -->
            <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="8">
                <FontIcon
                    FontSize="16"
                    Foreground="{ThemeResource AccentFillColorDefaultBrush}"
                    Glyph="&#xE80F;" />
                <TextBlock
                    VerticalAlignment="Center"
                    Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                    Text="Station:" />
                <TextBlock
                    VerticalAlignment="Center"
                    FontWeight="SemiBold"
                    Text="{x:Bind ViewModel.CurrentStationName, Mode=OneWay}" />
            </StackPanel>

            <!--  Lap Counter  -->
            <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="8">
                <FontIcon
                    FontSize="16"
                    Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                    Glyph="&#xE8EE;" />
                <TextBlock
                    VerticalAlignment="Center"
                    Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                    Text="Lap:" />
                <TextBlock
                    VerticalAlignment="Center"
                    FontWeight="SemiBold"
                    Text="{x:Bind ViewModel.CurrentLapDisplay, Mode=OneWay}" />
            </StackPanel>

            <!--  Journey Name  -->
            <StackPanel Grid.Column="2" Orientation="Horizontal" Spacing="8">
                <FontIcon
                    FontSize="16"
                    Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                    Glyph="&#xE81D;" />
                <TextBlock
                    VerticalAlignment="Center"
                    Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                    Text="Journey:" />
                <TextBlock
                    VerticalAlignment="Center"
                    FontWeight="SemiBold"
                    Text="{x:Bind ViewModel.CurrentJourneyName, Mode=OneWay}" />
            </StackPanel>

            <!--  Layout Name  -->
            <TextBlock
                Grid.Column="3"
                VerticalAlignment="Center"
                Foreground="{ThemeResource TextFillColorTertiaryBrush}"
                Text="{x:Bind ViewModel.LayoutName, Mode=OneWay}" />

            <!--  Sensor Status  -->
            <StackPanel Grid.Column="4" Orientation="Horizontal" Spacing="8">
                <FontIcon
                    FontSize="16"
                    Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                    Glyph="&#xE894;" />
                <TextBlock
                    VerticalAlignment="Center"
                    Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                    Text="{x:Bind ViewModel.SensorStatusText, Mode=OneWay}" />
            </StackPanel>
        </Grid>
    </Grid>
</Page>


