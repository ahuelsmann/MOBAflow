<Page
    x:Class="Moba.WinUI.View.EditorPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:converter="using:Moba.WinUI.Converter"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:domain="using:Moba.Domain"
    xmlns:i="using:Microsoft.Xaml.Interactivity"
    xmlns:local="using:Moba.WinUI.Behavior"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:viewmodel="using:Moba.SharedUI.ViewModel"
    x:Name="PageRoot"
    DataContext="{x:Bind ViewModel}"
    mc:Ignorable="d">
    <Page.Resources>
        <ResourceDictionary>
            <ResourceDictionary.MergedDictionaries>
                <ResourceDictionary Source="/Resources/EntityTemplates.xaml" />
            </ResourceDictionary.MergedDictionaries>

            <converter:BoolToVisibilityConverter x:Key="BoolToVisibilityConverter" />
            <converter:InverseBoolToVisibilityConverter x:Key="InverseBoolToVisibilityConverter" />
            <converter:HexColorToBrushConverter x:Key="HexColorToBrushConverter" />
            <converter:BoolToGlyphConverter
                x:Key="BoolToGlyphConverter"
                FalseValue="&#xE76C;"
                TrueValue="&#xE76B;" />
        </ResourceDictionary>
    </Page.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
        </Grid.RowDefinitions>

        <!--  Page Header  -->
        <StackPanel
            Grid.Row="0"
            Margin="16,2,16,2"
            Spacing="8">
            <TextBlock
                FontWeight="Bold"
                Style="{StaticResource TitleTextBlockStyle}"
                Text="Editor" />
        </StackPanel>

        <!--  TabView Navigation  -->
        <TabView
            x:Name="EditorTabView"
            Grid.Row="1"
            CanDragTabs="True"
            CanReorderTabs="True"
            IsAddTabButtonVisible="False"
            TabWidthMode="SizeToContent">

            <!--  ============================================  -->
            <!--  ============================================  -->
            <!--  Solution Tab: Projects + PropertyGrid  -->
            <!--  ============================================  -->
            <TabViewItem
                x:Name="SolutionTab"
                Header="Solution"
                IsClosable="False">
                <TabViewItem.IconSource>
                    <FontIconSource Glyph="&#xE8F1;" />
                </TabViewItem.IconSource>
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*" MinWidth="300" />
                        <ColumnDefinition Width="Auto" />
                        <ColumnDefinition
                            Width="400"
                            MinWidth="300"
                            MaxWidth="600" />
                    </Grid.ColumnDefinitions>

                    <!--  Column 0: Projects  -->
                    <Grid Grid.Column="0" Padding="4">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto" />
                            <RowDefinition Height="*" />
                        </Grid.RowDefinitions>
                        <TextBlock
                            Grid.Row="0"
                            Padding="16,6,24,4"
                            FontWeight="SemiBold"
                            Style="{StaticResource SubtitleTextBlockStyle}"
                            Text="Projects" />
                        <ListView
                            x:Name="ProjectsListView"
                            Grid.Row="1"
                            IsItemClickEnabled="True"
                            ItemsSource="{x:Bind ViewModel.SolutionViewModel.Projects, Mode=OneWay}"
                            SelectedItem="{x:Bind ViewModel.SelectedProject, Mode=TwoWay}"
                            SelectionMode="Single">
                            <i:Interaction.Behaviors>
                                <local:ListViewItemClickBehavior Command="{x:Bind ViewModel.ItemClickedCommand}" />
                            </i:Interaction.Behaviors>
                            <ListView.ItemTemplate>
                                <DataTemplate x:DataType="viewmodel:ProjectViewModel">
                                    <Grid Padding="6">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="Auto" />
                                            <ColumnDefinition Width="*" />
                                        </Grid.ColumnDefinitions>
                                        <FontIcon
                                            Grid.Column="0"
                                            Margin="0,0,8,0"
                                            FontSize="16"
                                            Glyph="&#xE8F1;" />
                                        <TextBlock
                                            Grid.Column="1"
                                            VerticalAlignment="Center"
                                            Text="{x:Bind Name, Mode=OneWay}" />
                                    </Grid>
                                </DataTemplate>
                            </ListView.ItemTemplate>
                        </ListView>
                    </Grid>

                    <Border
                        Grid.Column="1"
                        Width="1"
                        Background="{ThemeResource DividerStrokeColorDefaultBrush}" />

                    <!--  Column 2: PropertyGrid  -->
                    <Grid Grid.Column="2" Padding="4">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto" />
                            <RowDefinition Height="*" />
                        </Grid.RowDefinitions>
                        <TextBlock
                            Grid.Row="0"
                            Padding="16,6,24,4"
                            FontWeight="SemiBold"
                            Style="{StaticResource SubtitleTextBlockStyle}"
                            Text="Properties" />
                        <ContentControl
                            Grid.Row="1"
                            HorizontalContentAlignment="Stretch"
                            VerticalContentAlignment="Stretch"
                            Content="{x:Bind ViewModel.CurrentSelectedObject, Mode=OneWay}"
                            ContentTemplateSelector="{StaticResource EntityTemplateSelector}" />
                    </Grid>
                </Grid>
            </TabViewItem>

            <!--  ============================================  -->
            <!--  ============================================  -->
            <!--  Journeys Tab: Journeys + Stations + City Library + PropertyGrid  -->
            <!--  ============================================  -->
            <TabViewItem
                x:Name="JourneysTab"
                Header="Journeys"
                IsClosable="False">
                <TabViewItem.IconSource>
                    <FontIconSource Glyph="&#xE81D;" />
                </TabViewItem.IconSource>
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="250" MinWidth="200" />
                        <ColumnDefinition Width="Auto" />
                        <ColumnDefinition Width="250" MinWidth="200" />
                        <ColumnDefinition Width="Auto" />
                        <ColumnDefinition Width="250" MinWidth="200" />
                        <ColumnDefinition Width="Auto" />
                        <ColumnDefinition Width="*" MinWidth="300" />
                    </Grid.ColumnDefinitions>

                    <!--  Column 0: Journeys  -->
                    <Grid Grid.Column="0" Padding="4">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto" />
                            <RowDefinition Height="Auto" />
                            <RowDefinition Height="*" />
                            <RowDefinition Height="Auto" />
                        </Grid.RowDefinitions>
                        <TextBlock
                            Grid.Row="0"
                            Padding="16,6,24,4"
                            FontWeight="SemiBold"
                            Style="{StaticResource SubtitleTextBlockStyle}"
                            Text="Journeys" />
                        <AutoSuggestBox
                            Grid.Row="1"
                            Margin="8,0,8,4"
                            PlaceholderText="Search journeys..."
                            QueryIcon="Find"
                            Text="{x:Bind ViewModel.JourneySearchText, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" />
                        <ListView
                            x:Name="JourneysListView"
                            Grid.Row="2"
                            IsItemClickEnabled="True"
                            ItemsSource="{x:Bind ViewModel.SelectedProject.Journeys, Mode=OneWay}"
                            SelectedItem="{x:Bind ViewModel.SelectedJourney, Mode=TwoWay}"
                            SelectionMode="Single">
                            <i:Interaction.Behaviors>
                                <local:ListViewItemClickBehavior Command="{x:Bind ViewModel.ItemClickedCommand}" />
                            </i:Interaction.Behaviors>
                            <ListView.ContextFlyout>
                                <MenuFlyout>
                                    <MenuFlyoutItem Command="{x:Bind ViewModel.AddJourneyCommand}" Text="Add Journey">
                                        <MenuFlyoutItem.Icon>
                                            <FontIcon Glyph="&#xE710;" />
                                        </MenuFlyoutItem.Icon>
                                    </MenuFlyoutItem>
                                    <MenuFlyoutItem Command="{x:Bind ViewModel.DeleteJourneyCommand}" Text="Delete Journey">
                                        <MenuFlyoutItem.Icon>
                                            <FontIcon Glyph="&#xE738;" />
                                        </MenuFlyoutItem.Icon>
                                    </MenuFlyoutItem>
                                </MenuFlyout>
                            </ListView.ContextFlyout>
                            <ListView.ItemTemplate>
                                <DataTemplate x:DataType="viewmodel:JourneyViewModel">
                                    <Grid Padding="6">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="Auto" />
                                            <ColumnDefinition Width="*" />
                                        </Grid.ColumnDefinitions>
                                        <FontIcon
                                            Grid.Column="0"
                                            Margin="0,0,8,0"
                                            FontSize="16"
                                            Glyph="&#xE81D;" />
                                        <TextBlock
                                            Grid.Column="1"
                                            VerticalAlignment="Center"
                                            Text="{x:Bind Name, Mode=OneWay}" />
                                    </Grid>
                                </DataTemplate>
                            </ListView.ItemTemplate>
                        </ListView>
                    </Grid>

                    <Border
                        Grid.Column="1"
                        Width="1"
                        Background="{ThemeResource DividerStrokeColorDefaultBrush}" />

                    <!--  Column 2: Stations (of selected Journey)  -->
                    <Grid Grid.Column="2" Padding="4">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto" />
                            <RowDefinition Height="*" />
                        </Grid.RowDefinitions>
                        <TextBlock
                            Grid.Row="0"
                            Padding="16,6,24,4"
                            FontWeight="SemiBold"
                            Style="{StaticResource SubtitleTextBlockStyle}"
                            Text="Stations" />
                        <ListView
                            Grid.Row="1"
                            AllowDrop="True"
                            DragOver="StationListView_DragOver"
                            Drop="StationListView_Drop"
                            IsItemClickEnabled="True"
                            ItemsSource="{x:Bind ViewModel.SelectedJourney.Stations, Mode=OneWay}"
                            SelectedItem="{x:Bind ViewModel.SelectedStation, Mode=TwoWay}"
                            SelectionMode="Single">
                            <i:Interaction.Behaviors>
                                <local:ListViewItemClickBehavior Command="{x:Bind ViewModel.ItemClickedCommand}" />
                            </i:Interaction.Behaviors>
                            <ListView.ItemTemplate>
                                <DataTemplate x:DataType="viewmodel:StationViewModel">
                                    <Grid Padding="6">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="Auto" />
                                            <ColumnDefinition Width="*" />
                                        </Grid.ColumnDefinitions>

                                        <!--  Current Station Indicator (visible only when IsCurrentStation=true)  -->
                                        <Border
                                            Grid.ColumnSpan="2"
                                            Margin="-6"
                                            Background="{ThemeResource SystemAccentColorLight2}"
                                            CornerRadius="4"
                                            Opacity="0.3"
                                            Visibility="{x:Bind IsCurrentStation, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}" />

                                        <FontIcon
                                            Grid.Column="0"
                                            Margin="0,0,8,0"
                                            FontSize="16"
                                            Glyph="&#xE80F;" />
                                        <TextBlock
                                            Grid.Column="1"
                                            VerticalAlignment="Center"
                                            Text="{x:Bind Name, Mode=OneWay}" />
                                    </Grid>
                                </DataTemplate>
                            </ListView.ItemTemplate>
                        </ListView>
                    </Grid>

                    <Border
                        Grid.Column="3"
                        Width="1"
                        Background="{ThemeResource DividerStrokeColorDefaultBrush}" />

                    <!--  Column 4: City Library (for Drag & Drop)  -->
                    <Grid Grid.Column="4" Padding="4">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto" />
                            <RowDefinition Height="*" />
                        </Grid.RowDefinitions>
                        <TextBlock
                            Grid.Row="0"
                            Padding="16,6,24,4"
                            FontWeight="SemiBold"
                            Style="{StaticResource SubtitleTextBlockStyle}"
                            Text="City Library" />
                        <ListView
                            x:Name="CityLibraryListView"
                            Grid.Row="1"
                            CanDragItems="True"
                            DoubleTapped="CityListView_DoubleTapped"
                            DragItemsStarting="CityListView_DragItemsStarting"
                            ItemsSource="{x:Bind ViewModel.CityLibrary, Mode=OneWay}"
                            SelectedItem="{x:Bind ViewModel.SelectedCity, Mode=TwoWay}"
                            SelectionMode="Single">
                            <ListView.ItemTemplate>
                                <DataTemplate x:DataType="domain:City">
                                    <Grid Padding="6">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="Auto" />
                                            <ColumnDefinition Width="*" />
                                        </Grid.ColumnDefinitions>
                                        <FontIcon
                                            Grid.Column="0"
                                            Margin="0,0,8,0"
                                            FontSize="16"
                                            Glyph="&#xE80F;" />
                                        <TextBlock
                                            Grid.Column="1"
                                            VerticalAlignment="Center"
                                            Text="{x:Bind Name}" />
                                    </Grid>
                                </DataTemplate>
                            </ListView.ItemTemplate>
                        </ListView>
                    </Grid>

                    <Border
                        Grid.Column="5"
                        Width="1"
                        Background="{ThemeResource DividerStrokeColorDefaultBrush}" />

                    <!--  Column 6: PropertyGrid  -->
                    <Grid Grid.Column="6" Padding="4">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto" />
                            <RowDefinition Height="*" />
                        </Grid.RowDefinitions>
                        <TextBlock
                            Grid.Row="0"
                            Padding="16,6,24,4"
                            FontWeight="SemiBold"
                            Style="{StaticResource SubtitleTextBlockStyle}"
                            Text="Properties" />
                        <ContentControl
                            Grid.Row="1"
                            HorizontalContentAlignment="Stretch"
                            VerticalContentAlignment="Stretch"
                            Content="{x:Bind ViewModel.CurrentSelectedObject, Mode=OneWay}"
                            ContentTemplateSelector="{StaticResource EntityTemplateSelector}" />
                    </Grid>
                </Grid>
            </TabViewItem>

            <!--  ============================================  -->
            <!--  Workflows Tab: Workflows + Actions + PropertyGrid  -->
            <!--  ============================================  -->
            <TabViewItem
                x:Name="WorkflowsTab"
                Header="Workflows"
                IsClosable="False">
                <TabViewItem.IconSource>
                    <FontIconSource Glyph="&#xE713;" />
                </TabViewItem.IconSource>
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="300" MinWidth="200" />
                        <ColumnDefinition Width="Auto" />
                        <ColumnDefinition Width="300" MinWidth="200" />
                        <ColumnDefinition Width="Auto" />
                        <ColumnDefinition Width="*" MinWidth="300" />
                    </Grid.ColumnDefinitions>

                    <!--  Column 0: Workflows  -->
                    <Grid Grid.Column="0" Padding="4">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto" />
                            <RowDefinition Height="Auto" />
                            <RowDefinition Height="*" />
                            <RowDefinition Height="Auto" />
                        </Grid.RowDefinitions>
                        <TextBlock
                            Grid.Row="0"
                            Padding="16,6,24,4"
                            FontWeight="SemiBold"
                            Style="{StaticResource SubtitleTextBlockStyle}"
                            Text="Workflows" />
                        <AutoSuggestBox
                            Grid.Row="1"
                            Margin="8,0,8,4"
                            PlaceholderText="Search workflows..."
                            QueryIcon="Find"
                            Text="{x:Bind ViewModel.WorkflowSearchText, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" />
                        <ListView
                            x:Name="WorkflowsListView"
                            Grid.Row="2"
                            CanDragItems="True"
                            DragItemsStarting="WorkflowListView_DragItemsStarting"
                            IsItemClickEnabled="True"
                            ItemsSource="{x:Bind ViewModel.SelectedProject.Workflows, Mode=OneWay}"
                            SelectedItem="{x:Bind ViewModel.SelectedWorkflow, Mode=TwoWay}"
                            SelectionMode="Single">
                            <i:Interaction.Behaviors>
                                <local:ListViewItemClickBehavior Command="{x:Bind ViewModel.ItemClickedCommand}" />
                            </i:Interaction.Behaviors>
                            <ListView.ContextFlyout>
                                <MenuFlyout>
                                    <MenuFlyoutItem Command="{x:Bind ViewModel.AddWorkflowCommand}" Text="Add Workflow">
                                        <MenuFlyoutItem.Icon>
                                            <FontIcon Glyph="&#xE710;" />
                                        </MenuFlyoutItem.Icon>
                                    </MenuFlyoutItem>
                                    <MenuFlyoutItem Command="{x:Bind ViewModel.DeleteWorkflowCommand}" Text="Delete Workflow">
                                        <MenuFlyoutItem.Icon>
                                            <FontIcon Glyph="&#xE738;" />
                                        </MenuFlyoutItem.Icon>
                                    </MenuFlyoutItem>
                                </MenuFlyout>
                            </ListView.ContextFlyout>
                            <ListView.ItemTemplate>
                                <DataTemplate x:DataType="viewmodel:WorkflowViewModel">
                                    <Grid Padding="6">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="Auto" />
                                            <ColumnDefinition Width="*" />
                                        </Grid.ColumnDefinitions>
                                        <FontIcon
                                            Grid.Column="0"
                                            Margin="0,0,8,0"
                                            FontSize="16"
                                            Glyph="&#xE713;" />
                                        <TextBlock
                                            Grid.Column="1"
                                            VerticalAlignment="Center"
                                            Text="{x:Bind Name, Mode=OneWay}" />
                                    </Grid>
                                </DataTemplate>
                            </ListView.ItemTemplate>
                        </ListView>
                    </Grid>

                    <Border
                        Grid.Column="1"
                        Width="1"
                        Background="{ThemeResource DividerStrokeColorDefaultBrush}" />

                    <!--  Column 2: Actions (of selected Workflow)  -->
                    <Grid Grid.Column="2" Padding="4">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto" />
                            <RowDefinition Height="*" />
                        </Grid.RowDefinitions>
                        <TextBlock
                            Grid.Row="0"
                            Padding="16,6,24,4"
                            FontWeight="SemiBold"
                            Style="{StaticResource SubtitleTextBlockStyle}"
                            Text="Actions" />
                        <ListView
                            x:Name="ActionsListView"
                            Grid.Row="1"
                            IsItemClickEnabled="True"
                            ItemsSource="{x:Bind ViewModel.SelectedWorkflow.Actions, Mode=OneWay}"
                            SelectedItem="{x:Bind ViewModel.SelectedAction, Mode=TwoWay}"
                            SelectionMode="Single">
                            <i:Interaction.Behaviors>
                                <local:ListViewItemClickBehavior Command="{x:Bind ViewModel.ItemClickedCommand}" />
                            </i:Interaction.Behaviors>
                            <ListView.ItemTemplate>
                                <DataTemplate>
                                    <Grid Padding="6">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="Auto" />
                                            <ColumnDefinition Width="*" />
                                        </Grid.ColumnDefinitions>
                                        <FontIcon
                                            Grid.Column="0"
                                            Margin="0,0,8,0"
                                            FontSize="16"
                                            Glyph="&#xE945;" />
                                        <TextBlock Grid.Column="1" VerticalAlignment="Center">
                                            <Run FontWeight="SemiBold" Text="{Binding Name}" />
                                            <Run Foreground="{ThemeResource TextFillColorSecondaryBrush}" Text=" (" />
                                            <Run Foreground="{ThemeResource TextFillColorSecondaryBrush}" Text="{Binding Type}" />
                                            <Run Foreground="{ThemeResource TextFillColorSecondaryBrush}" Text=")" />
                                        </TextBlock>
                                    </Grid>
                                </DataTemplate>
                            </ListView.ItemTemplate>
                        </ListView>
                    </Grid>

                    <Border
                        Grid.Column="3"
                        Width="1"
                        Background="{ThemeResource DividerStrokeColorDefaultBrush}" />

                    <!--  Column 4: PropertyGrid  -->
                    <Grid Grid.Column="4" Padding="4">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto" />
                            <RowDefinition Height="*" />
                        </Grid.RowDefinitions>
                        <TextBlock
                            Grid.Row="0"
                            Padding="16,6,24,4"
                            FontWeight="SemiBold"
                            Style="{StaticResource SubtitleTextBlockStyle}"
                            Text="Properties" />
                        <ContentControl
                            Grid.Row="1"
                            HorizontalContentAlignment="Stretch"
                            VerticalContentAlignment="Stretch"
                            Content="{x:Bind ViewModel.CurrentSelectedObject, Mode=OneWay}"
                            ContentTemplateSelector="{StaticResource EntityTemplateSelector}" />
                    </Grid>
                </Grid>
            </TabViewItem>
        </TabView>
    </Grid>

    <VisualStateManager.VisualStateGroups>
        <VisualStateGroup x:Name="PropertiesStates">
            <VisualState x:Name="Expanded">
                <VisualState.Setters>
                    <Setter Target="PropertiesContent.Visibility" Value="Visible" />
                </VisualState.Setters>
                <VisualState.Storyboard>
                    <Storyboard>
                        <DoubleAnimation
                            Storyboard.TargetName="PropertiesContent"
                            Storyboard.TargetProperty="Opacity"
                            From="0.0"
                            To="1.0"
                            Duration="0:0:0.25">
                            <DoubleAnimation.EasingFunction>
                                <CubicEase EasingMode="EaseOut" />
                            </DoubleAnimation.EasingFunction>
                        </DoubleAnimation>
                    </Storyboard>
                </VisualState.Storyboard>
            </VisualState>

            <VisualState x:Name="Collapsed">
                <VisualState.Setters>
                    <Setter Target="PropertiesContent.Visibility" Value="Collapsed" />
                </VisualState.Setters>
                <VisualState.Storyboard>
                    <Storyboard>
                        <DoubleAnimation
                            Storyboard.TargetName="PropertiesContent"
                            Storyboard.TargetProperty="Opacity"
                            From="1.0"
                            To="0.0"
                            Duration="0:0:0.20">
                            <DoubleAnimation.EasingFunction>
                                <CubicEase EasingMode="EaseIn" />
                            </DoubleAnimation.EasingFunction>
                        </DoubleAnimation>
                    </Storyboard>
                </VisualState.Storyboard>
            </VisualState>
        </VisualStateGroup>
    </VisualStateManager.VisualStateGroups>
</Page>
